<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#fafafa; --shadow:0 6px 28px rgba(0,0,0,.08); }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    h1{font-weight:700;font-size:20px;margin:0 0 6px;text-align:center}
    .sub{color:var(--muted);font-size:12px;margin:0 0 14px;text-align:center}
    #chart{height:70vh;min-height:460px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);position:relative}
    #loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:#6b7280}
    #err{margin-top:10px;color:#b91c1c;font-size:12px;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
<div id="wrap">
  <h1 id="topTitle">Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones</h1>
  <p class="sub">Fuente: MEF- Consulta amigable</p>
  <div id="chart"><div id="loading">Cargando datos…</div></div>
  <div id="err"></div>
</div>

<script>
(function(){
  // Servicio / tabla
  const SERVICE = "https://portalgis.vivienda.gob.pe/servergis/rest/services/OGEI/Mapa_Inversiones_MEF/MapServer";
  const TABLE_ID = 3;
  const tableUrl = SERVICE + "/" + TABLE_ID;

  // Campos
  const F = {
    anio:"ano_eje", pim:"monto_pim", dev:"monto_devengado", funcion:"funcion_nombre",
    dpto:"departamento_ejecutora_nombre", prov:"provincia_ejecutora_nombre", dist:"distrito_ejecutora_nombre"
  };

  // Títulos externos
  const TITLE_LINE = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones";
  const TITLE_DEPT = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones según departamento ejecutora";
  const TITLE_PROV = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones según provincia ejecutora";
  const TITLE_DIST = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones según distrito ejecutora";

  // Formatos
  const nf1    = new Intl.NumberFormat("es-PE", { minimumFractionDigits:1, maximumFractionDigits:1 });
  const nf2cur = new Intl.NumberFormat("es-PE", { style:"currency", currency:"PEN", minimumFractionDigits:2, maximumFractionDigits:2 });
  function formatAxisShort(v){
    if(v == null || isNaN(v)) return "";
    const abs = Math.abs(v);
    if(abs >= 1_000_000) return "S/ " + nf1.format(v/1_000_000) + " mill";
    if(abs >= 1_000)     return "S/ " + nf1.format(v/1_000) + " mil";
    return "S/ " + nf1.format(v);
  }
  function formatLabelNoSuffix(v){
    if(v == null || isNaN(v)) return "";
    const abs = Math.abs(v);
    if(abs >= 1_000_000) return "S/ " + nf1.format(v/1_000_000);
    if(abs >= 1_000)     return "S/ " + nf1.format(v/1_000);
    return "S/ " + nf1.format(v);
  }

  // Paleta
  const BASE_HEX = "#2F4858";
  function hexToHsl(hex){
    const m=hex.replace('#','');
    const r=parseInt(m.slice(0,2),16)/255, g=parseInt(m.slice(2,4),16)/255, b=parseInt(m.slice(4,6),16)/255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2;
    if(max===min){h=s=0;}
    else{ const d=max-min; s=l>0.5? d/(2-max-min) : d/(max+min);
      switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;} h/=6; }
    return {h:Math.round(h*360), s:Math.round(s*100), l:Math.round(l*100)};
  }
  const baseHSL = hexToHsl(BASE_HEX);
  const hsl = (h,s,l,a=1)=>`hsla(${h} ${s}% ${l}% / ${a})`;
  const cPim = hsl(baseHSL.h, baseHSL.s, Math.min(85, baseHSL.l + 10));
  const cDev = hsl(baseHSL.h, baseHSL.s, Math.max(18, baseHSL.l - 8));

  // Util
  const $err = document.getElementById('err');
  const $loading = document.getElementById('loading');
  const $title = document.getElementById('topTitle');
  function setTopTitle(t){ $title.textContent = t; }
  function qs(url, params){ return url + "?" + new URLSearchParams(params).toString(); }
  async function getJSON(url, params={}, timeoutMs=25000){
    const u = qs(url, params);
    const ctrl = new AbortController();
    const to = setTimeout(()=>ctrl.abort(), timeoutMs);
    let res;
    try{ res = await fetch(u, { signal: ctrl.signal, mode:'cors', credentials:'omit' }); }
    finally{ clearTimeout(to); }
    if(!res.ok) throw new Error(`HTTP ${res.status} al consultar ${u}`);
    const data = await res.json();
    if(data.error) throw new Error((data.error && data.error.message) || "Error en respuesta del servicio");
    return { data, url: u };
  }
  function esc(v){ return String(v).replace(/'/g,"''"); }

  // ECharts
  const chart = echarts.init(document.getElementById('chart'));
  window.addEventListener('resize', ()=>chart.resize());

  // Leyenda con muestras de línea (para la vista de líneas)
  const ICON_SOLID  = 'path://M2,9 L26,9 L26,11 L2,11 Z';
  const ICON_DASHED = 'path://M2,9 L8,9 L8,11 L2,11 Z M10,9 L16,9 L16,11 L10,11 Z M18,9 L24,9 L24,11 L18,11 Z';

  const baseOption = {
    backgroundColor:'#ffffff',
    grid:{ left:96, right:40, top:110, bottom:90, containLabel:true },
    title: [
      { left:'center', top:10, text:'', textStyle:{ fontSize:16, fontWeight:700, color:'#111827' } },
      { left:'center', top:36, text:'', textStyle:{ fontSize:12, fontWeight:500, color:'#6b7280' } }
    ],
    legend:{
      top:64, left:'center',
      itemWidth:26, itemHeight:10,
      textStyle:{ fontSize:12 },
      data:[ { name:'PIM', icon: ICON_DASHED }, { name:'Devengado', icon: ICON_SOLID } ] // TRAZO para líneas
    },
    tooltip:{
      trigger:'axis',
      axisPointer:{ type:'line' },
      formatter:(params)=>{
        const x = params?.[0]?.axisValue ?? '';
        const lines = [`<b>${x}</b>`];
        (params||[]).forEach(p=>{
          const v = Number(p.value);
          const safe = Number.isFinite(v) ? v : 0;
          const full = nf2cur.format(safe);
          lines.push(`${p.marker} ${p.seriesName}: <b>${full}</b>`);
        });
        return lines.join('<br/>');
      }
    },
    xAxis:{ type:'category', boundaryGap:true, name:'Años', nameLocation:'middle', nameGap:34, axisTick:{alignWithLabel:true}, axisLabel:{margin:14}, animation:false, data:[] },
    yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v), margin:12 }, splitLine:{show:true}, scale:true },
    animation:true,
    animationDuration:1600,
    animationDurationUpdate:1600,
    series:[]
  };
  chart.setOption(baseOption);

  // Botón volver
  function backGraphic(color, onClick){
    const stroke = color;
    return [{
      type: 'group', left: 10, top: 10, z: 100, bounding: 'all', cursor: 'pointer', onclick: onClick,
      children: [
        {type:'circle', shape:{cx:18, cy:18, r:18}, style:{fill:'#fff', stroke:stroke, lineWidth:2, shadowBlur:6, shadowColor:'rgba(0,0,0,.08)'}},
        {type:'polyline', shape:{points:[[22,10],[14,18],[22,26]]}, style:{stroke:stroke, lineWidth:3, lineCap:'round', lineJoin:'round'}}
      ]
    }];
  }

  // Pila navegación
  let drillStack = [];
  function pushBack(fn){ drillStack.push(fn); }
  async function goBack(){
    if(!drillStack.length){ await loadLine(); return; }
    const fn = drillStack.pop(); await fn();
  }
  document.onkeydown = async (e)=>{ if(e.key==='Escape') goBack(); };

  // ====== Vista 0: Línea (Años) ======
  async function loadLine(){
    setTopTitle(TITLE_LINE);
    $loading.style.display = 'flex';

    const outStats = JSON.stringify([
      { statisticType:"sum", onStatisticField:F.pim, outStatisticFieldName:"sum_pim" },
      { statisticType:"sum", onStatisticField:F.dev, outStatisticFieldName:"sum_dev" }
    ]);

    const res = await getJSON(tableUrl + "/query", {
      where: `(${F.anio} IS NOT NULL) AND (UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO')) AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL)`,
      groupByFieldsForStatistics: F.anio,
      outStatistics: outStats,
      orderByFields: `${F.anio} ASC`,
      returnGeometry: "false", f: "json", resultType:"standard", cacheHint:"true"
    });

    const feats = res.data?.features || [];
    if(!feats.length) throw new Error("La consulta no devolvió filas.");

    const rows = feats.map(f=>({
      anio: Number(f.attributes[F.anio]),
      pim : Number(f.attributes.sum_pim || 0),
      dev : Number(f.attributes.sum_dev || 0)
    })).filter(r=>!isNaN(r.anio)).sort((a,b)=>a.anio-b.anio);

    const years = rows.map(r=>String(r.anio));
    const dataPim = rows.map(r=>r.pim);
    const dataDev = rows.map(r=>r.dev);

    chart.clear();
    chart.setOption({
      ...baseOption,
      title: [
        { ...baseOption.title[0], text: "" },
        { ...baseOption.title[1], text: "Función: SANEAMIENTO + SALUD Y SANEAMIENTO" }
      ],
      xAxis:{ ...baseOption.xAxis, data: years, name:'Años' },
      yAxis:{ ...baseOption.yAxis, name:'Monto (S/)' },
      legend:{ // leyenda con trazo (líneas)
        ...baseOption.legend
      },
      series:[
        { name:'PIM', type:'line', smooth:true, showSymbol:true, symbol:'circle', symbolSize:8,
          lineStyle:{ width:2, color:cPim, type:'dashed' }, itemStyle:{ color:cPim }, emphasis:{ focus:'series', scale:false }, clip:true,
          label:{ show:true, position:'top', distance:6, fontSize:11, color:'#111827',
                  formatter:(p)=> (p.value==null||isNaN(p.value)) ? '' : formatLabelNoSuffix(+p.value) },
          labelLayout:{ hideOverlap:true },
          data:dataPim },
        { name:'Devengado', type:'line', smooth:true, showSymbol:true, symbol:'circle', symbolSize:8,
          lineStyle:{ width:2, color:cDev, type:'solid' }, itemStyle:{ color:cDev }, emphasis:{ focus:'series', scale:false }, clip:true,
          label:{ show:true, position:'top', distance:6, fontSize:11, color:'#111827',
                  formatter:(p)=> (p.value==null||isNaN(p.value)) ? '' : formatLabelNoSuffix(+p.value) },
          labelLayout:{ hideOverlap:true },
          data:dataDev }
      ],
      graphic: [] // sin volver
    });

    chart.off('click');
    chart.on('click', (ev)=>{
      if(ev.componentType==='series' && ev.seriesType==='line'){
        const year = String(ev.name);
        drillStack = [];
        loadBarsDept({ year }).catch(showErr);
      }
    });

    $loading.style.display = 'none';
    $err.style.display = 'none';
    $err.textContent = '';
  }

  // ====== Vista 1: Barras por Departamento ======
  async function loadBarsDept({ year }){
    setTopTitle(TITLE_DEPT);
    $loading.style.display = 'flex';

    const outStats = JSON.stringify([
      { statisticType:"sum", onStatisticField:F.pim, outStatisticFieldName:"sum_pim" },
      { statisticType:"sum", onStatisticField:F.dev, outStatisticFieldName:"sum_dev" }
    ]);

    const res = await getJSON(tableUrl + "/query", {
      where: `${F.anio}=${Number(year)} AND UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO') AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL) AND ${F.dpto} IS NOT NULL`,
      groupByFieldsForStatistics: F.dpto,
      outStatistics: outStats,
      orderByFields: `sum_pim DESC`,
      returnGeometry: "false", f:"json", resultType:"standard", cacheHint:"true"
    });

    const feats = res.data?.features || [];
    if(!feats.length) throw new Error(`Sin datos para el año ${year}.`);

    const rows = feats.map(f=>({
      name: String(f.attributes[F.dpto]),
      pim : Number(f.attributes.sum_pim || 0),
      dev : Number(f.attributes.sum_dev || 0)
    })).filter(r=>r.name).sort((a,b)=>b.pim-a.pim);

    const x = rows.map(r=>r.name);
    const yP = rows.map(r=>r.pim);
    const yD = rows.map(r=>r.dev);

    chart.clear();
    chart.setOption({
      backgroundColor:'#fff',
      title: [
        { left:'center', top:10, text:`Departamentos — Año ${year}`, textStyle:{ fontSize:16, fontWeight:700, color:'#111827' } },
        { left:'center', top:36, text:`Función: SANEAMIENTO + SALUD Y SANEAMIENTO`, textStyle:{ fontSize:12, fontWeight:500, color:'#6b7280' } }
      ],
      grid:{ left:96, right:40, top:110, bottom:100, containLabel:true },
      legend:{                         // <- LEYENDA EN SÓLIDO PARA BARRAS
        top:64, left:'center',
        itemWidth:18, itemHeight:10,
        icon:'roundRect',
        textStyle:{ fontSize:12 },
        data:['PIM','Devengado']
      },
      tooltip: baseOption.tooltip,
      xAxis:{ type:'category', data:x, axisLabel:{ interval:0, rotate:(x.length>18?40:(x.length>12?25:0)) } },
      yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v) }, scale:true },
      series:[
        { name:'PIM', type:'bar', data:yP, itemStyle:{ color:cPim }, label:{ show:true, position:'top', formatter:(p)=>formatLabelNoSuffix(+p.value) } },
        { name:'Devengado', type:'bar', data:yD, itemStyle:{ color:cDev }, label:{ show:true, position:'top', formatter:(p)=>formatLabelNoSuffix(+p.value) } }
      ],
      animation:true,
      animationDuration:1200,
      graphic: backGraphic(cDev, ()=>goBack())
    });

    chart.off('click');
    chart.on('click', (ev)=>{
      if(ev.componentType==='series' && ev.seriesType==='bar'){
        const dep = ev.name;
        pushBack(()=>loadBarsDept({ year }));
        loadBarsProv({ year, dep }).catch(showErr);
      }
    });

    $loading.style.display = 'none';
  }

  // ====== Vista 2: Barras por Provincia ======
  async function loadBarsProv({ year, dep }){
    setTopTitle(TITLE_PROV);
    $loading.style.display = 'flex';

    const outStats = JSON.stringify([
      { statisticType:"sum", onStatisticField:F.pim, outStatisticFieldName:"sum_pim" },
      { statisticType:"sum", onStatisticField:F.dev, outStatisticFieldName:"sum_dev" }
    ]);

    const where =
      `${F.anio}=${Number(year)} AND UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO') `+
      `AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL) AND ${F.prov} IS NOT NULL `+
      `AND UPPER(${F.dpto})=UPPER('${esc(dep)}')`;

    const res = await getJSON(tableUrl + "/query", {
      where, groupByFieldsForStatistics: F.prov, outStatistics: outStats,
      orderByFields: `sum_pim DESC`,
      returnGeometry:"false", f:"json", resultType:"standard", cacheHint:"true"
    });

    const feats = res.data?.features || [];
    if(!feats.length) throw new Error(`Sin datos para ${dep} en ${year}.`);

    const rows = feats.map(f=>({
      name: String(f.attributes[F.prov]),
      pim : Number(f.attributes.sum_pim || 0),
      dev : Number(f.attributes.sum_dev || 0)
    })).filter(r=>r.name).sort((a,b)=>b.pim-a.pim);

    const x = rows.map(r=>r.name);
    const yP = rows.map(r=>r.pim);
    const yD = rows.map(r=>r.dev);

    chart.clear();
    chart.setOption({
      backgroundColor:'#fff',
      title: [
        { left:'center', top:10, text:`Departamento: ${dep}`, textStyle:{ fontSize:16, fontWeight:700, color:'#111827' } },
        { left:'center', top:36, text:`Año ${year} — Función: SANEAMIENTO + SALUD Y SANEAMIENTO`, textStyle:{ fontSize:12, fontWeight:500, color:'#6b7280' } }
      ],
      grid:{ left:96, right:40, top:110, bottom:100, containLabel:true },
      legend:{                         // <- sólido
        top:64, left:'center',
        itemWidth:18, itemHeight:10,
        icon:'roundRect',
        textStyle:{ fontSize:12 },
        data:['PIM','Devengado']
      },
      tooltip: baseOption.tooltip,
      xAxis:{ type:'category', data:x, axisLabel:{ interval:0, rotate:(x.length>18?40:(x.length>12?25:0)) } },
      yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v) }, scale:true },
      series:[
        { name:'PIM', type:'bar', data:yP, itemStyle:{ color:cPim }, label:{ show:true, position:'top', formatter:(p)=>formatLabelNoSuffix(+p.value) } },
        { name:'Devengado', type:'bar', data:yD, itemStyle:{ color:cDev }, label:{ show:true, position:'top', formatter:(p)=>formatLabelNoSuffix(+p.value) } }
      ],
      animation:true,
      animationDuration:1200,
      graphic: backGraphic(cDev, ()=>goBack())
    });

    chart.off('click');
    chart.on('click', (ev)=>{
      if(ev.componentType==='series' && ev.seriesType==='bar'){
        const prov = ev.name;
        pushBack(()=>loadBarsProv({ year, dep }));
        loadBarsDist({ year, dep, prov }).catch(showErr);
      }
    });

    $loading.style.display = 'none';
  }

  // ====== Vista 3: Barras por Distrito ======
  async function loadBarsDist({ year, dep, prov }){
    setTopTitle(TITLE_DIST);
    $loading.style.display = 'flex';

    const outStats = JSON.stringify([
      { statisticType:"sum", onStatisticField:F.pim, outStatisticFieldName:"sum_pim" },
      { statisticType:"sum", onStatisticField:F.dev, outStatisticFieldName:"sum_dev" }
    ]);

    const where =
      `${F.anio}=${Number(year)} AND UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO') `+
      `AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL) AND ${F.dist} IS NOT NULL `+
      `AND UPPER(${F.dpto})=UPPER('${esc(dep)}') AND UPPER(${F.prov})=UPPER('${esc(prov)}')`;

    const res = await getJSON(tableUrl + "/query", {
      where, groupByFieldsForStatistics: F.dist, outStatistics: outStats,
      orderByFields: `sum_pim DESC`,
      returnGeometry:"false", f:"json", resultType:"standard", cacheHint:"true"
    });

    const feats = res.data?.features || [];
    if(!feats.length) throw new Error(`Sin datos para ${prov} — ${dep} en ${year}.`);

    const rows = feats.map(f=>({
      name: String(f.attributes[F.dist]),
      pim : Number(f.attributes.sum_pim || 0),
      dev : Number(f.attributes.sum_dev || 0)
    })).filter(r=>r.name).sort((a,b)=>b.pim-a.pim);

    const x = rows.map(r=>r.name);
    const yP = rows.map(r=>r.pim);
    const yD = rows.map(r=>r.dev);

    chart.clear();
    chart.setOption({
      backgroundColor:'#fff',
      title: [
        { left:'center', top:10, text:`Departamento: ${dep} — Provincia: ${prov}`, textStyle:{ fontSize:16, fontWeight:700, color:'#111827' } },
        { left:'center', top:36, text:`Año ${year} — Función: SANEAMIENTO + SALUD Y SANEAMIENTO`, textStyle:{ fontSize:12, fontWeight:500, color:'#6b7280' } }
      ],
      grid:{ left:96, right:40, top:110, bottom:100, containLabel:true },
      legend:{                         // <- sólido
        top:64, left:'center',
        itemWidth:18, itemHeight:10,
        icon:'roundRect',
        textStyle:{ fontSize:12 },
        data:['PIM','Devengado']
      },
      tooltip: baseOption.tooltip,
      xAxis:{ type:'category', data:x, axisLabel:{ interval:0, rotate:(x.length>18?40:(x.length>12?25:0)) } },
      yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v) }, scale:true },
      series:[
        { name:'PIM', type:'bar', data:yP, itemStyle:{ color:cPim }, label:{ show:true, position:'top', formatter:(p)=>formatLabelNoSuffix(+p.value) } },
        { name:'Devengado', type:'bar', data:yD, itemStyle:{ color:cDev }, label:{ show:true, position:'top', formatter:(p)=>formatLabelNoSuffix(+p.value) } }
      ],
      animation:true,
      animationDuration:1200,
      graphic: backGraphic(cDev, ()=>goBack())
    });

    chart.off('click');
    $loading.style.display = 'none';
  }

  // Errores
  function showErr(e){
    $loading.style.display = 'none';
    $err.style.display = 'block';
    $err.textContent = "Error: " + (e && e.message ? e.message : e);
    console.error(e);
  }

  // Run
  (async function run(){
    try{
      $loading.style.display = 'flex';
      await loadLine();
      $loading.style.display = 'none';
      $err.style.display = 'none';
      $err.textContent = '';
    }catch(e){ showErr(e); }
  })();

  window.addEventListener('error', (ev)=>{ showErr(ev && ev.message ? ev.message : ev); }, true);
})();
</script>
</body>
</html>

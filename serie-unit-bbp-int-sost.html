<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BBP — series separadas (ajustado)</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden;background:#ffffff;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{height:100%;width:100%;display:grid;grid-template-rows:1fr 1fr 1fr;gap:10px;padding:10px}
    .panel{position:relative;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,.04);overflow:hidden}
    .hdr{position:absolute;inset:auto 12px 12px 12px;display:flex;gap:10px;align-items:center;pointer-events:none}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f9fafb;border:1px solid #e5e7eb;font-size:12px}
    .dot{width:10px;height:10px;border-radius:50%}
    .chart{position:absolute;inset:0}
    #err{
      position:absolute;left:10px;bottom:10px;display:none;
      background:rgba(255,255,255,.95);color:#b91c1c;font-size:11px;
      padding:6px 8px;border-radius:6px;max-width:min(780px,92%);white-space:pre-wrap;border:1px solid #fecaca
    }
  </style>
</head>
<body>
  <div id="wrap">
    <!-- BBP -->
    <div class="panel">
      <div id="chart-bbp" class="chart"></div>
      <div class="hdr">
        <span class="chip"><span class="dot" style="background:#0ea5e9"></span><b>BBP</b> — recuento por año</span>
      </div>
    </div>
    <!-- BBP SOSTENIBLE -->
    <div class="panel">
      <div id="chart-bbp-sost" class="chart"></div>
      <div class="hdr">
        <span class="chip"><span class="dot" style="background:#22c55e"></span><b>BBP SOSTENIBLE</b> — recuento por año</span>
      </div>
    </div>
    <!-- BBP INTEGRADOR -->
    <div class="panel">
      <div id="chart-bbp-int" class="chart"></div>
      <div class="hdr">
        <span class="chip"><span class="dot" style="background:#f59e0b"></span><b>BBP INTEGRADOR</b> — recuento por año</span>
      </div>
    </div>
  </div>

  <div id="err"></div>

<script>
(async function(){
  // === Servicio / filtros =====================================================
  const SERVICE_URL = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/mapa_swipe_viviendas_promovidas_storymap_hosted/FeatureServer/6/query";
  const REGION = "NACIONAL";
  const CODS  = [72, 75, 77]; // 72: BBP, 75: SOSTENIBLE, 77: INTEGRADOR
  const YEARS = ["2018","2019","2020","2021","2022","2023","2024"];

  const COLORS = { 72: "#0ea5e9", 75: "#22c55e", 77: "#f59e0b" };

  const $err = document.getElementById('err');
  const showErr = (m)=>{ $err.style.display='block'; $err.textContent=m; };
  const qs = (url, params)=> url + "?" + new URLSearchParams(params).toString();

  async function fetchRows(){
    const WHERE = `region_nombre='${REGION}' AND cod_var IN (${CODS.join(",")}) AND anio BETWEEN ${YEARS[0]} AND ${YEARS[YEARS.length-1]}`;
    const url = qs(SERVICE_URL, {
      where: WHERE,
      outFields: "anio,cod_var,recuento_total",
      orderByFields: "anio ASC, cod_var ASC",
      returnGeometry: "false",
      f: "json"
    });
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message || "Error del servicio");
    return (json.features || [])
      .map(f => f.attributes)
      .filter(r => r && r.anio != null && r.cod_var != null)
      .map(r => ({ anio: String(r.anio), cod: Number(r.cod_var), val: Number(r.recuento_total ?? 0) }));
  }

  // === Helpers ECharts (ajustes de ejes/espacios) ============================
  function baseOption(years, yMin, yMax){
    return {
      backgroundColor: '#ffffff',
      // Más aire alrededor para etiquetas y números
      grid: { left: 60, right: 30, top: 40, bottom: 48, containLabel: true },
      tooltip: {
        trigger: 'axis', confine: true,
        axisPointer: { type: 'line' },
        formatter: (params)=>{
          const p = params?.[0];
          const year = p?.axisValue ?? '';
          const val  = (p && isFinite(p.value)) ? new Intl.NumberFormat('es-PE').format(+p.value) : '—';
          return `<b>${year}</b><br/>${p?.marker || ''} Recuento: <b>${val}</b>`;
        }
      },
      xAxis: {
        type: 'category', boundaryGap: false,
        data: years,
        name: 'Año',
        nameLocation: 'middle',
        nameGap: 28,                    // separa el nombre del eje
        axisTick: { alignWithLabel: true },
        axisLabel: { fontSize: 12, margin: 12 },
        animation: false
      },
      yAxis: {
        type: 'value',
        name: 'Recuento',
        nameTextStyle: { padding: [0,0,0,-6], fontSize: 12 },
        axisLabel: {
          fontSize: 12,
          margin: 12,
          formatter: v => new Intl.NumberFormat('es-PE', { notation:'compact' }).format(v)
        },
        splitLine: { show: true },
        scale: true,
        min: yMin, max: yMax
      },
      animation: true,
      animationDuration: 4000,
      animationEasing: 'linear',
      animationDurationUpdate: 600
    };
  }

  function makeSeries(color){
    return [{
      type: 'line',
      smooth: true,
      showSymbol: true, symbol: 'diamond', symbolSize: 14, // un poco menor
      lineStyle: { width: 4, color },
      itemStyle: { color },
      label: {
        show: false,
        formatter: (p) => (p.value==null ? '' : new Intl.NumberFormat('es-PE').format(+p.value)),
        position: 'top',
        distance: 12,                  // más separación del punto
        fontSize: 11
      },
      data: YEARS.map(() => null)
    }];
  }

  // === Instancias de charts ===================================================
  const charts = {
    72: echarts.init(document.getElementById('chart-bbp')),
    75: echarts.init(document.getElementById('chart-bbp-sost')),
    77: echarts.init(document.getElementById('chart-bbp-int'))
  };

  // Resize responsivo
  window.addEventListener('resize', () => Object.values(charts).forEach(c => c.resize()), { passive:true });

  // Loading
  Object.values(charts).forEach(c => c.showLoading('default', { text:'Cargando…' }));

  try{
    const rows = await fetchRows();
    if (!rows.length) {
      Object.values(charts).forEach(c => c.hideLoading());
      showErr("No se recibieron registros para el filtro solicitado.");
      return;
    }

    // Indexar por cod → valores por año
    const byCodYear = { 72: {}, 75: {}, 77: {} };
    rows.forEach(r => { byCodYear[r.cod][r.anio] = r.val; });

    const seriesData = {};
    CODS.forEach(c => {
      seriesData[c] = YEARS.map(y => {
        const v = byCodYear[c][y];
        return (v==null || !isFinite(v)) ? null : +v;
      });
    });

    // Unificar escala Y (comparabilidad)
    const vals = CODS.flatMap(c => seriesData[c]).filter(v => v!=null && isFinite(v));
    let yMin = null, yMax = null;
    if (vals.length){
      const minVal = Math.min(...vals);
      const maxVal = Math.max(...vals);
      const pad = Math.max((maxVal - minVal) * 0.08, Math.max(1, Math.round(maxVal*0.01)));
      yMin = Math.max(0, Math.floor(minVal - pad));
      yMax = Math.ceil(maxVal + pad);
    }

    // Configurar y pintar cada gráfico
    CODS.forEach(c => {
      const opt = baseOption(YEARS, yMin, yMax);
      opt.color = [COLORS[c]];
      opt.series = makeSeries(COLORS[c]);
      charts[c].setOption(opt, true);
      charts[c].hideLoading();
      charts[c].setOption({ series: [{ data: seriesData[c] }] });

      // Mostrar etiquetas al finalizar animación inicial
      let labelsShown = false;
      charts[c].off('finished');
      charts[c].on('finished', () => {
        if (labelsShown) return;
        labelsShown = true;
        charts[c].setOption({ series: [{ label: { show: true } }] });
      });
    });

  }catch(e){
    Object.values(charts).forEach(c => c.hideLoading());
    console.error(e);
    showErr("Error: " + (e && e.message ? e.message : e));
  }
})();
</script>
</body>
</html>

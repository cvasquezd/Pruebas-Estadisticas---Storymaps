<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bubble chart — Gasto vs Acceso a agua (%) (tamaño: Población en miles)</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    #chart{height:100vh;width:100vw}
  </style>
</head>
<body>
<div id="chart"></div>

<script>
const SERVICE_BASE = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/Mapa_coropletico_2/FeatureServer";
const YEAR_START = 2011;
const YEAR_END   = 2024;

// IDs confirmados
const ID_GASTO      = 4; // ejecucion total (S/)
const ID_POBLACION  = 3; // ENAPRES (miles)
const ID_PORCENTAJE = 6; // tb_pob_porcentaje_1 (Acceso a agua %)

const REGION_COLS = [
  { key:'amazonas', display:'Amazonas', macro:'NORTE' },
  { key:'ancash', display:'Áncash', macro:'CENTRO' },
  { key:'apurimac', display:'Apurímac', macro:'SUR' },
  { key:'arequipa', display:'Arequipa', macro:'SUR' },
  { key:'ayacucho', display:'Ayacucho', macro:'SUR' },
  { key:'cajamarca', display:'Cajamarca', macro:'NORTE' },
  { key:'provincia_constitucional_del_ca', display:'Callao', macro:'LIMA Y CALLAO' },
  { key:'cusco', display:'Cusco', macro:'SUR' },
  { key:'huancavelica', display:'Huancavelica', macro:'SUR' },
  { key:'huanuco', display:'Huánuco', macro:'CENTRO' },
  { key:'ica', display:'Ica', macro:'SUR' },
  { key:'junin', display:'Junín', macro:'CENTRO' },
  { key:'la_libertad', display:'La Libertad', macro:'NORTE' },
  { key:'lambayeque', display:'Lambayeque', macro:'NORTE' },
  { key:'lima', display:'Lima', macro:'LIMA Y CALLAO' },
  { key:'loreto', display:'Loreto', macro:'NORTE' },
  { key:'madre_de_dios', display:'Madre de Dios', macro:'SUR' },
  { key:'moquegua', display:'Moquegua', macro:'SUR' },
  { key:'pasco', display:'Pasco', macro:'CENTRO' },
  { key:'piura', display:'Piura', macro:'NORTE' },
  { key:'puno', display:'Puno', macro:'SUR' },
  { key:'san_martin', display:'San Martín', macro:'NORTE' },
  { key:'tacna', display:'Tacna', macro:'SUR' },
  { key:'tumbes', display:'Tumbes', macro:'NORTE' },
  { key:'ucayali', display:'Ucayali', macro:'NORTE' }
];

const MACRO_COLORS = {
  'NORTE': '#1f77b4',
  'CENTRO': '#2ca02c',
  'SUR': '#d62728',
  'LIMA Y CALLAO': '#ff7f0e'
};

const chart = echarts.init(document.getElementById('chart'));

function qs(url, params) {
  return url + "?" + new URLSearchParams(params).toString();
}

async function fetchTable(layerId) {
  const url = qs(`${SERVICE_BASE}/${layerId}/query`, {
    where: "1=1",
    outFields: "*",
    returnGeometry: "false",
    orderByFields: "anio ASC",
    f: "json"
  });
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} al consultar layer ${layerId}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error.message || `Error del servicio en layer ${layerId}`);
  const feats = json.features || [];
  const byYear = new Map();
  for (const f of feats) {
    const a = (f.attributes || {});
    const yrRaw = a.anio;
    const yr = typeof yrRaw === 'string' ? parseInt(yrRaw, 10) : Number(yrRaw);
    if (Number.isFinite(yr)) byYear.set(yr, a);
  }
  return byYear;
}

function extent(arr) {
  let min = +Infinity, max = -Infinity;
  for (const v of arr) if (Number.isFinite(v)) { if (v < min) min = v; if (v > max) max = v; }
  if (!Number.isFinite(min) || !Number.isFinite(max)) return [0,1];
  if (min === max) return [0, max || 1];
  return [min, max];
}
function positiveExtent(arr) { // para eje log
  let min = +Infinity, max = -Infinity;
  for (const v0 of arr) {
    const v = Number(v0);
    if (Number.isFinite(v) && v > 0) { if (v < min) min = v; if (v > max) max = v; }
  }
  if (!Number.isFinite(min) || !Number.isFinite(max)) return [1, 10];
  return [min, max];
}
function makeSizeFn(values) {
  const [, mx] = extent(values);
  return function sizeFn(x) {
    const v = Math.max(0, Number(x)||0);
    const t = mx > 0 ? (v / mx) : 0;
    return (Math.sqrt(t) + 0.10) * 60;
  };
}

(async function run(){
  try {
    chart.showLoading({ text: 'Cargando datos…' });

    // Traer tablas: Y(%) - Size(miles) - X(S/)
    const [accesoPctByYear, poblacionByYear, gastoByYear] = await Promise.all([
      fetchTable(ID_PORCENTAJE), // Y (%)
      fetchTable(ID_POBLACION),  // tamaño
      fetchTable(ID_GASTO)       // X (S/)
    ]);

    const years = [];
    for (let y = YEAR_START; y <= YEAR_END; y++) years.push(y);

    // Recolectar valores para escalas
    const allX = [], allY = [], allSize = [];
    years.forEach(y => {
      const rAcc = accesoPctByYear.get(y) || {};
      const rPop = poblacionByYear.get(y) || {};
      const rGas = gastoByYear.get(y) || {};
      for (const {key} of REGION_COLS) {
        const x = Number(rGas[key]);
        const yv = Number(rAcc[key]);
        const sz = Number(rPop[key]);
        if (Number.isFinite(x) && x > 0) allX.push(x);
        if (Number.isFinite(yv)) allY.push(yv);
        if (Number.isFinite(sz)) allSize.push(sz);
      }
    });

    const [xMin, xMax] = positiveExtent(allX);
    const [yDataMin, yDataMax] = extent(allY);
    const yMin = Math.min(0, yDataMin);
    const yMax = Math.max(100, yDataMax);
    const sizeFn = makeSizeFn(allSize);

    // Opciones por año
    const options = [];
    for (const y of years) {
      const rowAcc = accesoPctByYear.get(y) || {};
      const rowPop = poblacionByYear.get(y) || {};
      const rowGas = gastoByYear.get(y) || {};

      const points = REGION_COLS.map(({key, display, macro}) => {
        const gasto     = Number(rowGas[key]); // X (log)
        const accesoPct = Number(rowAcc[key]); // Y (%)
        const poblacion = Number(rowPop[key]); // Size
        return {
          value: [gasto, accesoPct, poblacion, display, macro],
          itemStyle: { color: MACRO_COLORS[macro] }
        };
      })
      .filter(d =>
        Number.isFinite(d.value[0]) && d.value[0] > 0 &&
        Number.isFinite(d.value[1])
      );

      options.push({
        title: { show: true, text: String(y) },
        series: [{
          name: String(y),
          type: 'scatter',
          data: points,
          itemStyle: { opacity: 0.85 },
          symbolSize: (val) => sizeFn(val[2]),
          label: {
            show: true,
            formatter: (p) => p.value[3],
            position: 'right',
            fontSize: 10,
            color: '#333'
          }
        }]
      });
    }

    // Configuración ECharts
    const option = {
      baseOption: {
        timeline: {
          axisType: 'category',
          orient: 'vertical',
          autoPlay: true,
          inverse: true,
          playInterval: 1200,
          right: 0,
          top: 20,
          bottom: 20,
          width: 55,
          symbol: 'none',
          checkpointStyle: { borderWidth: 2 },
          controlStyle: { showNextBtn: false, showPrevBtn: false },
          data: years
        },
        title: [
          {
            text: years[0],
            textAlign: 'center',
            left: '63%',
            top: '55%',
            textStyle: { fontSize: 80, fontWeight: 600, color: '#e5e7eb' }
          },
          {
            text: 'Gasto (S/) vs Acceso a agua (%) — tamaño: Población (miles)',
            left: 'center',
            top: 8,
            textStyle: { fontWeight: '600', fontSize: 16 }
          }
        ],
        tooltip: {
          padding: 6,
          borderWidth: 1,
          formatter: function (obj) {
            const [gasto, accesoPct, poblacion, region, macro] = obj.value;
            const nf = new Intl.NumberFormat('es-PE');
            const pf = new Intl.NumberFormat('es-PE', { maximumFractionDigits: 2 });
            return `
              <b>${region}</b> (${macro})<br>
              Acceso a agua: <b>${pf.format(accesoPct)}%</b><br>
              Gasto (S/): <b>${nf.format(gasto)}</b><br>
              Población (miles): <b>${nf.format(poblacion)}</b>
            `;
          }
        },
        grid: { top: 80, left: 40, right: 110, bottom: 40, containLabel: true },
        xAxis: {
          type: 'log',
          name: 'Gasto (S/)',
          min: xMin * 0.8,
          max: xMax * 1.2,
          nameGap: 25,
          nameLocation: 'middle',
          nameTextStyle: { fontSize: 14 },
          splitLine: { show: false },
          axisLabel: { formatter: (v) => new Intl.NumberFormat('es-PE').format(v) }
        },
        yAxis: {
          type: 'value',
          name: 'Acceso a agua (%)',
          min: yMin,
          max: yMax,
          nameTextStyle: { fontSize: 14 },
          splitLine: { show: true },
          axisLabel: {
            formatter: (v) => `${new Intl.NumberFormat('es-PE', { maximumFractionDigits: 0 }).format(v)}%`
          }
        },
        series: [ { type: 'scatter', data: [] } ],
        animationDurationUpdate: 1000,
        animationEasingUpdate: 'quinticInOut'
      },
      options
    };

    chart.hideLoading();
    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());
  } catch (err) {
    console.error(err);
    chart.hideLoading();
    chart.setOption({
      title: { text:'Error al cargar datos', left:'center' },
      graphic: {
        type:'text', left:'center', top:'middle',
        style:{ text: (err && err.message) ? err.message :
          'Fallo de carga.\nRevisa conectividad o permisos del servicio.', fontSize: 14 }
      }
    });
  }
})();
</script>
</body>
</html>

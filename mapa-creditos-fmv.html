<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Créditos MiVivienda — puntos con líneas (cod_var=70)</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<style>
  html,body{height:100%;margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #chart{width:100%;height:100vh}
  #err{position:fixed;left:10px;bottom:10px;display:none;background:#fff;border:1px solid #fecaca;color:#b91c1c;padding:8px 10px;border-radius:8px;font-size:12px;max-width:min(560px,92%);white-space:pre-wrap}
</style>
</head>
<body>
<div id="chart"></div>
<div id="err"></div>

<script>
(async function(){
  // ===== CONFIG SENCILLA =====
  const SERVICE = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/mapa_swipe_viviendas_promovidas_storymap_hosted/FeatureServer";
  const LYR_LIMITES = 1;     // solo esta capa para base y centroides
  const TBL_VAL     = 6;     // tabla con recuento_total
  const COD_VAR     = 70;
  const YEAR        = 2024;  // <-- cambia el año aquí si hace falta
  const NAME_FIELD  = "region_nombre";

  // Departamentos que preferimos etiquetar a la IZQUIERDA del punto
  const LEFT_SIDE = ["AMAZONAS","LORETO","SAN MARTIN","UCAYALI","MADRE DE DIOS"].map(s=>norm(s));

  const $err = document.getElementById('err');
  const showErr = m => { $err.style.display='block'; $err.textContent=m; };

  const qs = (u,p)=> u+"?"+new URLSearchParams(p).toString();
  function norm(s){ return (s||"").toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/\s+/g," ").trim(); }
  const nf = v => new Intl.NumberFormat('es-PE').format(v||0);

  // ---- utilidades geométricas súper simples ----
  function esriRingsToPolygon(rings){ return { type:"Polygon", coordinates: rings.map(r=>r.map(([x,y])=>[x,y])) }; }
  function centroidOf(poly){
    const ring = poly.coordinates[0]; if(!ring || ring.length<3) return null;
    let x=0,y=0,a=0;
    for(let i=0;i<ring.length-1;i++){ const [x1,y1]=ring[i], [x2,y2]=ring[i+1]; const c=x1*y2-x2*y1; a+=c; x+=(x1+x2)*c; y+=(y1+y2)*c; }
    if(a===0){ const n=ring.length, sx=ring.reduce((s,p)=>s+p[0],0), sy=ring.reduce((s,p)=>s+p[1],0); return [sx/n, sy/n]; }
    a*=0.5; return [x/(6*a), y/(6*a)];
  }

  // ---- límites -> geojson + centroides (solo layer 1) ----
  async function getLimitesYCentroides(){
    const url = qs(`${SERVICE}/${LYR_LIMITES}/query`, {
      where:"1=1", outFields:"*", returnGeometry:"true", outSR:4326, f:"json"
    });
    const r = await fetch(url, {cache:"no-store"}); if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    const feats = j.features||[];
    const geoFeats = [];
    const cent = new Map();   // norm(nombre) -> [lon,lat]
    const pretty = new Map(); // norm(nombre) -> nombre original

    feats.forEach(f=>{
      const nm = f.attributes?.[NAME_FIELD];
      if(!nm || !f.geometry?.rings) return;
      const poly = esriRingsToPolygon(f.geometry.rings);
      geoFeats.push({ type:"Feature", properties:{ name:nm }, geometry: poly });
      const c = centroidOf(poly); if(c){ cent.set(norm(nm), c); pretty.set(norm(nm), nm); }
    });

    // “Lima y Callao” (usa el centro de Lima)
    if(cent.has(norm("LIMA")) && cent.has(norm("CALLAO")) && !cent.has(norm("LIMA Y CALLAO"))){
      cent.set(norm("LIMA Y CALLAO"), cent.get(norm("LIMA")));
      pretty.set(norm("LIMA Y CALLAO"), "Lima y Callao");
    }

    return { geojson:{type:"FeatureCollection",features:geoFeats}, centroides:cent, pretty };
  }

  // ---- valores por region_nombre desde tabla 6 ----
  async function getValores(){
    const url = qs(`${SERVICE}/${TBL_VAL}/query`, {
      where:`cod_var=${COD_VAR} AND anio=${YEAR}`,
      groupByFieldsForStatistics: NAME_FIELD,
      outStatistics: JSON.stringify([{statisticType:"sum", onStatisticField:"recuento_total", outStatisticFieldName:"v"}]),
      outFields: NAME_FIELD, returnGeometry:"false", f:"json"
    });
    const r = await fetch(url, {cache:"no-store"}); if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    const map = new Map();
    (j.features||[]).forEach(f=>{
      const nm = f.attributes?.[NAME_FIELD];
      map.set(norm(nm), Number(f.attributes?.v||0));
    });
    // compatibilidad si te llega “LIMA Y CALLAO”
    if(map.has(norm("LIMA Y CALLAO"))){
      map.set(norm("LIMA"), map.get(norm("LIMA Y CALLAO")));
      map.set(norm("CALLAO"), map.get(norm("LIMA Y CALLAO")));
    }
    return map;
  }

  // ====== Render mínimo ======
  const chart = echarts.init(document.getElementById('chart'));
  chart.showLoading('default', {text:'Cargando…'});

  try{
    const [{geojson, centroides, pretty}, valores] = await Promise.all([
      getLimitesYCentroides(),
      getValores()
    ]);

    echarts.registerMap('peru', geojson, {});
    const offset = 46; // separación etiqueta

    const lines = [];
    const points = [];
    centroides.forEach((xy, k)=>{
      const v = valores.get(k) ?? 0;
      const dir = LEFT_SIDE.includes(k) ? -1 : (xy[0] < -74 ? 1 : -1); // heurística simple
      lines.push({ value:[xy[0], xy[1], dir] });
      points.push({
        name: k,
        value:[xy[0], xy[1], v],
        label:{ offset:[dir*offset, 0] }
      });
    });

    chart.setOption({
      backgroundColor:'#fff',
      title:{ text:`NÚMERO DE CRÉDITOS MIVIVIENDA POR DEPARTAMENTO — ${YEAR}`, top:8, left:'center', textStyle:{fontSize:16,fontWeight:700} },
      tooltip:{
        trigger:'item', confine:true,
        formatter:(p)=>{
          const nice = pretty.get(norm(p.name)) || p.name;
          const v = Array.isArray(p.value) ? p.value[2] : (valores.get(norm(p.name))||0);
          return `<b>${nice}</b><br/>Créditos: <b>${nf(v)}</b>`;
        }
      },
      geo:{
        map:'peru', roam:true, zoom:1.05,
        itemStyle:{ borderColor:'#9ca3af', borderWidth:1, areaColor:'#f8fafc' },
        emphasis:{ itemStyle:{ areaColor:'#e5f3ff' } }
      },
      series:[
        { name:'Perú', type:'map', map:'peru', geoIndex:0, z:1,
          itemStyle:{ borderColor:'#9ca3af', borderWidth:1, areaColor:'#f8fafc' } },
        { // líneas guía en píxeles
          name:'Guías', type:'custom', coordinateSystem:'geo', z:2, silent:true,
          renderItem: (params, api)=>{
            const x=api.value(0), y=api.value(1), dir=api.value(2);
            const p0=api.coord([x,y]); const p1=[p0[0]+dir*offset, p0[1]];
            return { type:'line', shape:{x1:p0[0],y1:p0[1],x2:p1[0],y2:p1[1]}, style:{stroke:'#94a3b8',lineWidth:1.2} };
          },
          data: lines
        },
        { // punto + etiqueta: "region_nombre  recuento_total"
          name:'Créditos', type:'scatter', coordinateSystem:'geo', z:3, symbolSize:8,
          itemStyle:{ color:'#16a34a' },
          data: points,
          label:{
            show:true, position:'right',
            formatter:(p)=> `${(pretty.get(norm(p.name))||p.name)}  ${nf(p.value[2])}`,
            backgroundColor:'#fff', borderColor:'rgba(0,0,0,.12)', borderWidth:1, borderRadius:999,
            padding:[2,6], color:'#0b1220', fontSize:11, shadowBlur:4, shadowColor:'rgba(0,0,0,.08)'
          }
        }
      ]
    });

    chart.hideLoading();

    // Aviso si hay valores que no encontramos en límites
    const falt = [];
    valores.forEach((_, k)=>{ if(!centroides.has(k)) falt.push(k); });
    if(falt.length) showErr("Aviso: sin geometría para: " + falt.join(", "));
  }catch(e){
    console.error(e); chart.hideLoading(); showErr("Error: " + (e && e.message ? e.message : e));
  }
})();
</script>
</body>
</html>

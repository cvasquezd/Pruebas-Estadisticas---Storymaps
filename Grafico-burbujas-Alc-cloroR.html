<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Evolución de Principales Indicadores de Saneamiento</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    #wrap{position:relative;height:100vh;width:100vw}
    #chart{height:100%;width:100%}

    /* ===== Trigger + Tooltip de leyenda (debajo del título) ===== */
    .legend-bar{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:46px;                /* bajo el título principal */
      z-index:10;
      display:flex;gap:10px;align-items:center;
      pointer-events:auto;
    }
    .legend-trigger{
      font-size:12px;font-weight:600;color:#2563eb;
      background:rgba(255,255,255,.9);
      border:1px solid #e5e7eb;border-radius:999px;
      padding:4px 10px;cursor:default;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
      user-select:none;
    }
    .legend-tip{
      position:absolute;left:50%;transform:translateX(-50%);
      top:28px;                 /* aparece debajo del trigger */
      background:rgba(255,255,255,.96);
      backdrop-filter:saturate(130%) blur(2px);
      border:1px solid #e5e7eb;border-radius:12px;
      padding:10px 12px;min-width:220px;max-width:260px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      font-size:12px;color:#374151;
      display:none;pointer-events:none;
    }
    .legend-tip h4{margin:0 0 6px 0;font-size:12px;font-weight:700;color:#111827}
    .lg-row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .lg-chip{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.08);flex:0 0 auto}
    .muted{color:#6b7280}

    .legend-trigger:hover + .legend-tip{display:block}

    @media (max-width: 720px){
      .legend-bar{top:56px}
    }
  </style>
</head>
<body>
<div id="wrap">
  <div id="chart"></div>

  <!-- Texto que muestra la leyenda como tooltip al pasar el mouse -->
  <div class="legend-bar" aria-hidden="true">
    <div class="legend-trigger">Leyenda burbuja</div>
    <div class="legend-tip" role="tooltip" aria-label="Leyenda de colores para porcentaje de población con cloro residual aceptable">
      <h4>Color por % Cl aceptable</h4>
      <div class="lg-row"><span class="lg-chip" style="background:#2ecc71"></span><span>≥ 75%</span></div>
      <div class="lg-row"><span class="lg-chip" style="background:#f1c40f"></span><span>60% – 74%</span></div>
      <div class="lg-row"><span class="lg-chip" style="background:#fb8c00"></span><span>40% – 59%</span></div>
      <div class="lg-row"><span class="lg-chip" style="background:#e57373"></span><span>15% – 39%</span></div>
      <div class="lg-row"><span class="lg-chip" style="background:#c62828"></span><span>0% – 14%</span></div>
      <div class="lg-row"><span class="lg-chip" style="background:#9e9e9e"></span><span class="muted">Sin dato</span></div>
    </div>
  </div>
</div>

<script>
const SERVICE_BASE = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/Mapa_coropletico_2/FeatureServer";
const YEAR_START = 2017;
const YEAR_END   = 2024;

/* ===== Layer IDs ===== */
const ID_CONTINUIDAD = 10; // X: continuidad en horas
const ID_ACCESO_PCT  = 6;  // Y: % acceso a agua
const ID_PCT_ALCDSE  = 16; // tamaño: % Pob. con Alc/DSE  (tb_porcent_pob_c_alcdse)
const ID_CLORO_OK    = 12; // color: % Pob. con Cl aceptable (tb_pob_cloro_residual_acept)

/* ===== Regiones con código (01–25) ===== */
const REGIONS = [
  { code:'01', norm:'amazonas',  display:'Amazonas',  macro:'NORTE' },
  { code:'02', norm:'ancash',    display:'Áncash',    macro:'CENTRO' },
  { code:'03', norm:'apurimac',  display:'Apurímac',  macro:'SUR' },
  { code:'04', norm:'arequipa',  display:'Arequipa',  macro:'SUR' },
  { code:'05', norm:'ayacucho',  display:'Ayacucho',  macro:'SUR' },
  { code:'06', norm:'cajamarca', display:'Cajamarca', macro:'NORTE' },
  {
    code:'07', norm:'callao', display:'Callao', macro:'LIMA Y CALLAO',
    syns:[
      'callao','provincia constitucional del callao','provincia_constitucional_del_callao',
      '07: provincia constitucional del callao','07 provincia constitucional del callao',
      '07_provincia_constitucional_del_callao','07: PROVINCIA CONSTITUCIONAL DEL CALLAO',
      'provincia_constitucional_del_ca'
    ]
  },
  { code:'08', norm:'cusco',     display:'Cusco',     macro:'SUR' },
  { code:'09', norm:'huancavelica', display:'Huancavelica', macro:'SUR' },
  { code:'10', norm:'huanuco',   display:'Huánuco',   macro:'CENTRO' },
  { code:'11', norm:'ica',       display:'Ica',       macro:'SUR' },
  { code:'12', norm:'junin',     display:'Junín',     macro:'CENTRO' },
  { code:'13', norm:'la_libertad', display:'La Libertad', macro:'NORTE' },
  { code:'14', norm:'lambayeque', display:'Lambayeque', macro:'NORTE' },
  { code:'15', norm:'lima',      display:'Lima',      macro:'LIMA Y CALLAO', syns:['lima_metropolitana'] },
  { code:'16', norm:'loreto',    display:'Loreto',    macro:'NORTE' },
  { code:'17', norm:'madre_de_dios', display:'Madre de Dios', macro:'SUR', syns:['madre_de','madre'] },
  { code:'18', norm:'moquegua',  display:'Moquegua',  macro:'SUR' },
  { code:'19', norm:'pasco',     display:'Pasco',     macro:'CENTRO' },
  { code:'20', norm:'piura',     display:'Piura',     macro:'NORTE' },
  { code:'21', norm:'puno',      display:'Puno',      macro:'SUR' },
  { code:'22', norm:'san_martin', display:'San Martín', macro:'NORTE', syns:['sanmartin','san_martin'] },
  { code:'23', norm:'tacna',     display:'Tacna',     macro:'SUR' },
  { code:'24', norm:'tumbes',    display:'Tumbes',    macro:'NORTE' },
  { code:'25', norm:'ucayali',   display:'Ucayali',   macro:'NORTE' }
];

const chart = echarts.init(document.getElementById('chart'));

/* ================== Utilidades ================== */
function qs(url, params){ return url + "?" + new URLSearchParams(params).toString(); }
function normalizeKey(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().replace(/[^a-z0-9:]+/g,'_')
    .replace(/^_+|_+$/g,'');
}
function stripPrefixNum(nk){ return nk.replace(/^\d+\s*[:_]?_*/,''); }
const STOP = new Set(['de','del','la','el','los','las','provincia','constitucional','institucional','metropolitana']);
function tokens(s){ return stripPrefixNum(normalizeKey(s)).split('_').filter(t=>t && !STOP.has(t)); }

function parseNum(v){
  if (typeof v === 'number' && Number.isFinite(v)) return v;
  if (v == null) return NaN;
  let s = String(v).trim();
  if (!s) return NaN;
  s = s.replace(/\s/g,'').replace(/%/g,'');
  const hasComma = s.includes(','), hasDot = s.includes('.');
  if (hasComma && !hasDot) s = s.replace(/,/g,'.'); else if (hasComma && hasDot) s = s.replace(/,/g,'');
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function parseYear(v){
  const digits = String(v||'').match(/\d/g);
  if (!digits) return NaN;
  const n = Number(digits.join(''));
  if (Number.isFinite(n) && n >= 1900 && n <= 2100) return n;
  const n2 = parseNum(v);
  return (n2>=1900 && n2<=2100) ? n2 : NaN;
}
function buildRowIndex(row){
  const map = {};
  for(const k of Object.keys(row||{})){
    const nk  = normalizeKey(k);
    const nk2 = stripPrefixNum(nk);
    if(!(nk  in map)) map[nk]  = k;
    if(!(nk2 in map)) map[nk2] = k;
  }
  return map;
}
function getValueByDeptCode(rowIndex, row, code2){
  for (const nk of Object.keys(rowIndex)){
    const m = nk.match(/^(\d{2,3})\s*[:_]/);
    if (m && m[1].padStart(2,'0') === String(code2).padStart(2,'0')) {
      const real = rowIndex[nk];
      const v = parseNum(row[real]);
      if (Number.isFinite(v)) return v;
    }
  }
  return NaN;
}
function getValueBySynonyms(rowIndex, row, region){
  const candSet = new Set([region.norm, ...(region.syns||[])]);
  for (const c of candSet){
    const nk  = normalizeKey(c), nk2 = stripPrefixNum(nk);
    const real = rowIndex[nk] ?? rowIndex[nk2];
    if (real != null && row[real] != null){
      const v = parseNum(row[real]);
      if (Number.isFinite(v)) return v;
    }
  }
  const rtoks = tokens(region.norm);
  let bestKey=null, bestScore=-1;
  for (const nk of Object.keys(rowIndex)){
    const tks = tokens(nk);
    let score = 0;
    for (const t of rtoks) if (tks.includes(t)) score++;
    if (nk.includes(normalizeKey(region.norm))) score += 0.5;
    if (score > bestScore){ bestScore = score; bestKey = nk; }
  }
  if (bestKey){
    const v = parseNum(row[rowIndex[bestKey]]);
    if (Number.isFinite(v)) return v;
  }
  return NaN;
}
function getRegionValue(rowIndex, row, region){
  const byCode = getValueByDeptCode(rowIndex, row, region.code);
  if (Number.isFinite(byCode)) return byCode;
  return getValueBySynonyms(rowIndex, row, region);
}
function detectYearKeyFromAttrs(attrs){
  const keys = Object.keys(attrs||{});
  const preferred = ['año','anio','ano','a_o','a_os','year','periodo'];
  for(const k of keys){
    const nk = normalizeKey(k), nk2 = stripPrefixNum(nk);
    if (preferred.includes(k) || preferred.includes(nk) || preferred.includes(nk2) || nk.startsWith('anio') || nk.startsWith('ano')) return k;
  }
  for(const k of keys){
    const yr = parseYear(attrs[k]);
    if(Number.isFinite(yr)) return k;
  }
  return null;
}
async function fetchTableFlexible(layerId){
  const url = qs(`${SERVICE_BASE}/${layerId}/query`, {
    where:"1=1", outFields:"*", returnGeometry:"false", f:"json"
  });
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status} al consultar layer ${layerId}`);
  const json = await res.json();
  if(json.error) throw new Error(json.error.message || `Error del servicio en layer ${layerId}`);
  const byYear = new Map();
  for(const f of (json.features||[])){
    const a = f.attributes || {};
    const yearKey = detectYearKeyFromAttrs(a);
    if(!yearKey) continue;
    const yr = parseYear(a[yearKey]);
    if(Number.isFinite(yr) && yr >= YEAR_START && yr <= YEAR_END) byYear.set(yr, a);
  }
  return byYear;
}
function extent(arr){let m=+Infinity,M=-Infinity;for(const v of arr)if(Number.isFinite(v)){if(v<m)m=v;if(v>M)M=v}if(!Number.isFinite(m)||!Number.isFinite(M))return[0,1];if(m===M)return[0,M||1];return[m,M]}
function quantile(a,q){const s=a.slice().sort((x,y)=>x-y);if(!s.length)return NaN;const p=(s.length-1)*q,lo=Math.floor(p),hi=Math.ceil(p);return lo===hi?s[lo]:s[hi]+(s[hi]-s[lo])*(p-lo)}

/* Tamaño con límites (minPx, maxPx) y raíz para suavizar */
function makeSizeFn(values, minPx=12, maxPx=52){
  const [mn,mx]=extent(values);
  return x=>{
    const v=Math.max(0,Number(x)||0);
    let t = (mx>mn) ? (v-mn)/(mx-mn) : 0.5;       // [0,1]
    t = Math.max(0, Math.min(1, t));
    return minPx + Math.sqrt(t)*(maxPx-minPx);    // raíz = menos saturación en altos
  }
}

/* Colores: % Pob. con Cl aceptable */
function colorForCloro(p){
  const v = Number(p);
  if(!Number.isFinite(v)) return '#9e9e9e';     // gris si no hay dato
  if(v >= 75) return '#2ecc71';                // verde
  if(v >= 60) return '#f1c40f';                // amarillo
  if(v >= 40) return '#fb8c00';                // naranja
  if(v >= 15) return '#e57373';                // rojo tenue
  return '#c62828';                             // rojo intenso
}

/* ================== Render ================== */
(async function run(){
  try{
    chart.showLoading({ text: 'Cargando datos…' });

    const [contByYear, accesoPctByYear, pctAlcDseByYear, cloroOkByYear] = await Promise.all([
      fetchTableFlexible(ID_CONTINUIDAD), // X (horas)
      fetchTableFlexible(ID_ACCESO_PCT),  // Y (% acceso)
      fetchTableFlexible(ID_PCT_ALCDSE),  // tamaño: % Pob. con Alc/DSE
      fetchTableFlexible(ID_CLORO_OK)     // color: % Pob. con Cl aceptable
    ]);

    const years=[]; const allX=[], allY=[], allSize=[];
    for(let y=YEAR_START;y<=YEAR_END;y++){
      const rowX=contByYear.get(y), rowY=accesoPctByYear.get(y), rowS=pctAlcDseByYear.get(y);
      if(!rowX || !rowY || !rowS) continue;
      const idxX=buildRowIndex(rowX), idxY=buildRowIndex(rowY), idxS=buildRowIndex(rowS);
      let any=false;
      for(const r of REGIONS){
        const xv=getRegionValue(idxX,rowX,r);
        const yv=getRegionValue(idxY,rowY,r);
        const sv=getRegionValue(idxS,rowS,r);   // % Alc/DSE (0–100)
        if(Number.isFinite(xv)) allX.push(xv);
        if(Number.isFinite(yv)) allY.push(yv);
        if(Number.isFinite(sv)) allSize.push(sv);
        if(Number.isFinite(xv) && Number.isFinite(yv)) any=true;
      }
      if(any) years.push(y);
    }
    if(!years.length) throw new Error('No hay años con datos válidos para X e Y.');

    const xQ05=quantile(allX,0.05), xQ95=quantile(allX,0.95);
    const yQ05=quantile(allY,0.05), yQ95=quantile(allY,0.95);
    const xPad=(xQ95-xQ05)*0.05, yPad=(yQ95-yQ05)*0.05;
    const [xMinAll,xMaxAll]=extent(allX), [yMinAll,yMaxAll]=extent(allY);
    const xInitMin = Math.min(xQ05 - xPad, xMinAll);
    const xInitMax = Math.max(xQ95 + xPad, xMaxAll);
    const clamp01 = v => Math.max(0, Math.min(100, v));
    const yInitMin = clamp01(Math.min(yQ05 - yPad, yMinAll));
    const yInitMax = clamp01(Math.max(yQ95 + yPad, yMaxAll));

    const sizeFn = makeSizeFn(allSize, 12, 52); // ← límites del tamaño

    const options=[];
    for(const y of years){
      const rowX=contByYear.get(y), rowY=accesoPctByYear.get(y), rowS=pctAlcDseByYear.get(y), rowC=cloroOkByYear.get(y)||{};
      const idxX=buildRowIndex(rowX), idxY=buildRowIndex(rowY), idxS=buildRowIndex(rowS), idxC=buildRowIndex(rowC);

      const points = REGIONS.map(r=>{
        const X = getRegionValue(idxX,rowX,r);      // horas
        const Y = getRegionValue(idxY,rowY,r);      // % acceso
        const S = getRegionValue(idxS,rowS,r);      // % Alc/DSE (0–100) — tamaño
        const PCL = getRegionValue(idxC,rowC,r);    // % cloro aceptable (0–100) — color
        return { value:[X,Y,S,r.display,r.macro,PCL], itemStyle:{ color: colorForCloro(PCL), opacity:0.85 } };
      }).filter(d => Number.isFinite(d.value[0]) && Number.isFinite(d.value[1]));

      options.push({
        title:{ show:true, text:String(y) },
        series:[{
          name:String(y),
          type:'scatter',
          data:points,
          symbolSize:(val)=>sizeFn(val[2]),  // tamaño controlado
          emphasis:{ scale:1.08, focus:'self' },
          label:{ show:true, formatter:(p)=>p.value[3], position:'right', fontSize:10, color:'#333' }
        }]
      });
    }

    const pf0 = new Intl.NumberFormat('es-PE',{ maximumFractionDigits:0 });
    const pf1 = new Intl.NumberFormat('es-PE',{ maximumFractionDigits:1 });
    const pf2 = new Intl.NumberFormat('es-PE',{ maximumFractionDigits:2 });

    const option={
      baseOption:{
        timeline:{
          axisType:'category', orient:'vertical', autoPlay:true, inverse:true,
          playInterval:1200, right:0, top:20, bottom:20, width:55, symbol:'none',
          checkpointStyle:{ borderWidth:2 }, controlStyle:{ showNextBtn:false, showPrevBtn:false },
          data: years
        },
        title:[
          { text: years[0], right: 155, bottom: 52, textAlign: 'right',
            textStyle: { fontSize: 32, fontWeight: 700, color: '#e5e7eb' } },
          { text: 'Evolución de Principales Indicadores de Saneamiento',
            left: 'center', top: 8, textStyle: { fontWeight: '700', fontSize: 16 } }
        ],
        tooltip:{
          padding:6, borderWidth:1,
          formatter:(obj)=>{
            const [cont, acceso, pctAlcDse, region, macro, pcl] = obj.value;
            const pclTxt    = Number.isFinite(pcl) ? pf2.format(pcl) + '%' : '—';
            const alcDseTxt = Number.isFinite(pctAlcDse) ? pf2.format(pctAlcDse) + '%' : '—';
            return `
              <b>${region}</b> (${macro})<br>
              Continuidad: <b>${pf1.format(cont)} h</b><br>
              Acceso a agua: <b>${pf2.format(acceso)}%</b><br>
              % Acceso a Alc/DSE (tamaño): <b>${alcDseTxt}</b><br>
              % Pob. con Cl aceptable (color): <b>${pclTxt}</b>
            `;
          }
        },
        grid:{ top:86, left:40, right:140, bottom:90, containLabel:true },
        xAxis:{ type:'value', name:'Continuidad del servicio (horas)',
          min:xInitMin, max:xInitMax, nameGap:25, nameLocation:'middle',
          nameTextStyle:{ fontSize:14 }, splitLine:{ show:true },
          axisLabel:{ formatter:(v)=>`${pf1.format(v)}` } },
        yAxis:{ type:'value', name:'Acceso a agua (%)',
          min:yInitMin, max:yInitMax, nameTextStyle:{ fontSize:14 }, splitLine:{ show:true }, scale:true,
          axisLabel:{ formatter:(v)=>`${pf0.format(v)}%` } },
        dataZoom:[
          { type:'slider', xAxisIndex:0, filterMode:'none', bottom:12, height:28 },
          { type:'inside', xAxisIndex:0, filterMode:'none' },
          { type:'slider', yAxisIndex:0, filterMode:'none', right:6, width:12 },
          { type:'inside', yAxisIndex:0, filterMode:'none' }
        ],
        series:[{ type:'scatter', data:[] }],
        animationDurationUpdate:1000,
        animationEasingUpdate:'quinticInOut'
      },
      options
    };

    chart.hideLoading();
    chart.setOption(option);
    window.addEventListener('resize', ()=>chart.resize());
  }catch(err){
    console.error(err);
    chart.hideLoading();
    chart.setOption({
      title:{ text:'Error al cargar datos', left:'center' },
      graphic:{ type:'text', left:'center', top:'middle',
        style:{ text: (err&&err.message)? err.message : 'Fallo de carga.', fontSize:14 } }
    });
  }
})();
</script>
</body>
</html>

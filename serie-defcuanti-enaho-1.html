<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Déficit Cuantitativo ENAHO (%) — compacto</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden;background:#ffffff;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    /* Ocupa todo el panel del Story Map */
    #chart{width:100%;height:100%}
    /* Error flotante (no provoca scroll) */
    #err{
      position:absolute;left:6px;bottom:6px;display:none;
      background:rgba(255,255,255,.9);color:#b91c1c;font-size:11px;
      padding:6px 8px;border-radius:6px;max-width:92%;white-space:pre-wrap
    }
  </style>
</head>
<body>
  <div id="chart"></div>
  <div id="err"></div>

<script>
(async function(){
  // === Servicio / filtros ====================================================
  const SERVICE_URL = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/mapa_swipe_viviendas_promovidas_storymap_hosted/FeatureServer/6/query";
  const WHERE = "cod_var = 46 AND region_nombre = 'NACIONAL' AND anio BETWEEN 2017 AND 2024";

  const YEARS = ["2017","2018","2019","2020","2021","2022","2023","2024"];

  const COLORS = { total:"#0ea5e9", urbano:"#22c55e", rural:"#ef4444" };

  const $err = document.getElementById('err');
  const chart = echarts.init(document.getElementById('chart'));
  window.addEventListener('resize', () => chart.resize(), { passive:true });

  const byYear = Object.create(null);

  const qs = (url, params)=> url + "?" + new URLSearchParams(params).toString();
  const showErr = (m)=>{ $err.style.display='block'; $err.textContent=m; };

  async function fetchRows(){
    const url = qs(SERVICE_URL, {
      where: WHERE,
      outFields: "anio,porcentaje_total,porcentaje_urbano,porcentaje_rural",
      orderByFields: "anio ASC",
      returnGeometry: "false",
      f: "json"
    });
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message || "Error del servicio");
    const rows = (json.features || []).map(f => f.attributes);
    return rows
      .filter(r => r && r.anio != null)
      .sort((a,b) => Number(a.anio) - Number(b.anio))
      .map(r => ({
        anio: String(r.anio),
        total:  r.porcentaje_total  == null ? null : Number(r.porcentaje_total),
        urbano: r.porcentaje_urbano == null ? null : Number(r.porcentaje_urbano),
        rural:  r.porcentaje_rural  == null ? null : Number(r.porcentaje_rural),
      }));
  }

  function firstValidIndex(arr){
    for(let i=0;i<arr.length;i++){ const v=arr[i]; if(v!=null && isFinite(v)) return i; }
    return -1;
  }
  function makeSeed(arr){
    const idx = firstValidIndex(arr);
    if(idx < 0) return arr.slice();
    const v0 = arr[idx];
    return arr.map((v,i)=> i < idx ? null : v0);
  }

  chart.setOption({
    backgroundColor: '#ffffff',
    color: [COLORS.total, COLORS.urbano, COLORS.rural],
    /* más espacio para la leyenda, compacto sin scroll */
    grid: { left: 54, right: 12, top: 54, bottom: 30, containLabel: true },
    legend: {
      top: 8, left: 'center',
      itemWidth: 14, itemHeight: 8, icon: 'roundRect',
      textStyle: { fontSize: 11 },
      data: ['Total (%)','Urbano (%)','Rural (%)']
    },
    tooltip: {
      trigger: 'axis', confine: true,
      axisPointer: { type: 'line' },
      formatter: function (params) {
        const year = params?.[0]?.axisValue ?? '';
        const row = byYear[year];
        const cfg = [
          { name: 'Total (%)',  key: 'total'  },
          { name: 'Urbano (%)', key: 'urbano' },
          { name: 'Rural (%)',  key: 'rural'  }
        ];
        const markers = {}; (params || []).forEach(p => { markers[p.seriesName] = p.marker; });
        const dotGray = '<span style="display:inline-block;margin-right:4px;border-radius:50%;width:10px;height:10px;background:#ccc"></span>';
        const lines = [`<b>${year}</b>`];
        cfg.forEach(c => {
          const v = row && isFinite(row[c.key]) ? Number(row[c.key]) : null;
          const val = v==null ? '—' : v.toFixed(2) + '%';
          const marker = markers[c.name] || dotGray;
          lines.push(`${marker} ${c.name}: <b>${val}</b>`);
        });
        return lines.join('<br/>');
      }
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: YEARS,
      name: 'Año', nameLocation: 'middle', nameGap: 20,
      axisLabel: { fontSize: 11 },
      axisTick: { alignWithLabel: true },
      animation: false
    },
    yAxis: {
      type: 'value',
      name: '%',
      nameTextStyle: { padding: [0,0,0,-4], fontSize: 11 },
      axisLabel: { formatter: '{value}%', fontSize: 11 },
      splitLine: { show: true },
      scale: true
    },
    animationDuration: 900,
    animationEasing: 'linear',
    animationDurationUpdate: 600,
    series: [
      {
        name:'Total (%)', type:'line',
        smooth: 0.25, smoothMonotone: 'x',
        connectNulls: false, clip: true,
        showSymbol:true, symbol:'circle', symbolSize:6,
        lineStyle:{ width:2, color: COLORS.total },
        itemStyle:{ color: COLORS.total },
        label:{ show:false, formatter: p => (p.value==null?'':(+p.value).toFixed(2)+'%'), position:'top', distance:6, fontSize:10 }
      },
      {
        name:'Urbano (%)', type:'line',
        smooth: 0.25, smoothMonotone: 'x',
        connectNulls: false, clip: true,
        showSymbol:true, symbol:'circle', symbolSize:6,
        lineStyle:{ width:2, color: COLORS.urbano },
        itemStyle:{ color: COLORS.urbano },
        label:{ show:false, formatter: p => (p.value==null?'':(+p.value).toFixed(2)+'%'), position:'top', distance:6, fontSize:10 }
      },
      {
        name:'Rural (%)', type:'line',
        smooth: 0.25, smoothMonotone: 'x',
        connectNulls: false, clip: true,
        showSymbol:true, symbol:'circle', symbolSize:6,
        lineStyle:{ width:2, color: COLORS.rural },
        itemStyle:{ color: COLORS.rural },
        label:{ show:false, formatter: p => (p.value==null?'':(+p.value).toFixed(2)+'%'), position:'top', distance:6, fontSize:10 }
      }
    ]
  });

  chart.showLoading('default', { text:'Cargando…' });

  let labelsShown = false;

  try{
    const all = await fetchRows();
    chart.hideLoading();

    if (!all.length) {
      showErr("No se recibieron registros para el filtro solicitado.");
      return;
    }

    all.forEach(r => byYear[r.anio] = r);

    const totalData  = YEARS.map(y => (byYear[y] ? byYear[y].total  : null));
    const urbanoData = YEARS.map(y => (byYear[y] ? byYear[y].urbano : null));
    const ruralData  = YEARS.map(y => (byYear[y] ? byYear[y].rural  : null));

    const seedTotal  = makeSeed(totalData);
    const seedUrbano = makeSeed(urbanoData);
    const seedRural  = makeSeed(ruralData);

    const vals = [...totalData, ...urbanoData, ...ruralData].filter(v => v!=null && isFinite(v));
    if (vals.length) {
      const minVal = Math.min(...vals);
      const maxVal = Math.max(...vals);
      const pad = Math.max((maxVal - minVal) * 0.08, 0.5);
      chart.setOption({ yAxis: { min: Math.floor(minVal - pad), max: Math.ceil(maxVal + pad) }});
    }

    chart.setOption({ series: [ {data:seedTotal}, {data:seedUrbano}, {data:seedRural} ] });
    requestAnimationFrame(() => {
      chart.setOption({ series: [ {data:totalData}, {data:urbanoData}, {data:ruralData} ] });
    });

    chart.off('finished');
    chart.on('finished', () => {
      if (labelsShown) return; labelsShown = true;
      chart.setOption({ series: [ {label:{show:true}}, {label:{show:true}}, {label:{show:true}} ] });
    });

  }catch(e){
    chart.hideLoading();
    console.error(e);
    showErr("Error: " + (e && e.message ? e.message : e));
  }
})();
</script>
</body>
</html>


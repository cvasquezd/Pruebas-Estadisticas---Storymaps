<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Distribución del déficit por área (compacto)</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#fafafa;
      --shadow:0 3px 12px rgba(0,0,0,.07);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    /* Layout compacto para panel de Story Map */
    #wrap{max-width:320px;margin:6px auto;padding:0 8px}
    #chart{
      height:320px;           /* ajusta aquí si lo necesitas (280–360px) */
      min-height:260px;
      background:var(--card);
      border-radius:12px;
      box-shadow:var(--shadow)
    }
    #err{margin-top:6px;color:#b91c1c;font-size:11px;white-space:pre-wrap}
    @media (max-width:480px){
      #wrap{padding:0 6px}
      #chart{height:300px;min-height:250px}
    }
  </style>
</head>
<body>
<div id="wrap">
  <div id="chart"></div>
  <div id="err"></div>
</div>

<script>
(async function () {
  // ===== Config =====
  const SERVICE_URL = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/mapa_swipe_viviendas_promovidas_storymap_hosted/FeatureServer/6/query";
  const WHERE = "cod_var = 50 AND region_nombre = 'NACIONAL' AND anio BETWEEN 2017 AND 2024";
  const STEP_MS = 1000; // velocidad: 1s por año

  const $err = document.getElementById('err');
  function qs(url, params){ return url + "?" + new URLSearchParams(params).toString(); }

  async function fetchRows(){
    const url = qs(SERVICE_URL, {
      where: WHERE,
      outFields: "anio,porcentaje_urbano,porcentaje_rural",
      orderByFields: "anio ASC",
      returnGeometry: "false",
      f: "json"
    });
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    if(json.error) throw new Error(json.error.message || "Error del servicio");

    const rows = (json.features || [])
      .map(f => f.attributes)
      .filter(r => r && r.anio != null)
      .sort((a,b) => Number(a.anio) - Number(b.anio))
      .map(r => {
        let u = +Number(r.porcentaje_urbano ?? 0);
        let rr = +Number(r.porcentaje_rural ?? 0);
        const s = u + rr;
        if (s > 0 && (s < 99 || s > 101)) { u = u / s * 100; rr = rr / s * 100; }
        return { anio: String(r.anio), u: +u.toFixed(2), r: +rr.toFixed(2) };
      });
    return rows;
  }

  // ===== Chart =====
  const chart = echarts.init(document.getElementById('chart'));
  window.addEventListener('resize', () => chart.resize());

  const years = [], urbano = [], rural = [];
  const baseOption = {
    backgroundColor: '#ffffff',
    color: ['#5470C6', '#22C55E'], // Urbano, Rural
    grid: { left: 48, right: 12, top: 28, bottom: 36, containLabel: true }, // márgenes compactos
    legend: {
      top: 6, left: 'center', selectedMode: false,
      itemWidth: 14, itemHeight: 8, icon: 'roundRect',
      textStyle: { fontSize: 11 }, data: ['Urbano','Rural']
    },
    tooltip: {
      trigger: 'axis', axisPointer: { type: 'shadow' }, confine: true,
      formatter: (ps) => {
        const y = ps?.[0]?.axisValueLabel || '';
        const lines = [`<b>${y}</b>`];
        ps.forEach(p => lines.push(`${p.marker} ${p.seriesName}: <b>${(+p.value).toFixed(2)}%</b>`));
        return lines.join('<br/>');
      }
    },
    xAxis: {
      type: 'category', data: years, name: 'Año',
      nameLocation: 'middle', nameGap: 22,
      axisLabel:{ fontSize: 11 }, axisTick:{alignWithLabel:true}
    },
    yAxis: {
      type: 'value', min:0, max:100,
      axisLabel:{ formatter: '{value}%', fontSize: 11 },
      splitLine:{show:true}
    },
    animation: true,
    series: [
      {
        name:'Urbano', type:'bar', stack:'total', barWidth:'60%',
        data: urbano,
        label:{ show:true, position:'inside', formatter:(p)=> `${(+p.value).toFixed(1)}%`, fontSize: 10 },
        emphasis:{ focus:'series' }
      },
      {
        name:'Rural', type:'bar', stack:'total', barWidth:'60%',
        data: rural,
        label:{ show:true, position:'inside', formatter:(p)=> `${(+p.value).toFixed(1)}%`, fontSize: 10 },
        emphasis:{ focus:'series' }
      }
    ]
  };
  chart.setOption(baseOption);

  // ===== Carga + animación =====
  try{
    const rows = await fetchRows();
    if (!rows.length) throw new Error("No se recibieron registros para el filtro solicitado.");

    let i = 0;
    years.push(rows[0].anio);
    urbano.push(rows[0].u);
    rural.push(rows[0].r);
    chart.setOption({ xAxis:{ data: years }, series:[ {data: urbano}, {data: rural} ] });

    const timer = setInterval(() => {
      i++;
      if (i >= rows.length) { clearInterval(timer); return; }
      years.push(rows[i].anio);
      urbano.push(rows[i].u);
      rural.push(rows[i].r);
      chart.setOption({ xAxis:{ data: years }, series:[ {data: urbano}, {data: rural} ] });
    }, STEP_MS);

  }catch(e){
    console.error(e);
    $err.textContent = "Error: " + (e && e.message ? e.message : e);
  }
})();
</script>
</body>
</html>


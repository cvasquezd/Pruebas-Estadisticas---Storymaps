<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#fafafa; --shadow:0 6px 28px rgba(0,0,0,.08); }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    h1{font-weight:700;font-size:20px;margin:0 0 6px;text-align:center}
    .sub{color:var(--muted);font-size:12px;margin:0 0 14px;text-align:center}
    #toolbar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:6px 0 8px}
    .btn{
      appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:999px;
      padding:8px 14px;font-size:12px;font-weight:600;color:#374151;cursor:pointer;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .btn:hover{background:#f9fafb}
    .btn-primary{background:#111827;color:#fff;border-color:#111827}
    .btn-primary:hover{opacity:.95}
    /* Popover */
    .pop-wrap{position:relative}
    .popover{
      position:absolute; left:50%; transform:translateX(-50%); top:44px; width:380px; max-width:90vw;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:var(--shadow);
      padding:10px; z-index:9999; display:none;
    }
    .popover.open{display:block}
    .pop-title{font-size:12px; font-weight:700; color:#111827; margin:2px 2px 8px}
    .pop-help{font-size:11px;color:#6b7280;margin:-4px 2px 8px}
    .list{max-height:260px; overflow:auto; padding:4px}
    .opt{
      display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; cursor:pointer;
    }
    .opt:hover{background:#f3f4f6}
    .opt input{width:16px; height:16px}
    /* Chart */
    #chart{height:70vh;min-height:460px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);position:relative}
    #loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:#6b7280}
    #err{margin-top:10px;color:#b91c1c;font-size:12px;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
<div id="wrap">
  <h1 id="topTitle">Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones</h1>
  <p class="sub">Fuente: MEF- Consulta amigable</p>

  <!-- ===== Toolbar ===== -->
  <div id="toolbar">
    <div class="pop-wrap">
      <button id="btnDept" class="btn">Departamento Ejec ▾</button>
      <div id="popDept" class="popover" role="dialog" aria-label="Departamento (ejecutora)">
        <div class="pop-title">Departamento (ejecutora)</div>
        <div class="pop-help">Marca múltiples opciones</div>
        <div id="listDept" class="list"></div>
      </div>
    </div>
    <div class="pop-wrap">
      <button id="btnProv" class="btn">Provincia Ejec ▾</button>
      <div id="popProv" class="popover" role="dialog" aria-label="Provincia (ejecutora)">
        <div class="pop-title">Provincia (ejecutora)</div>
        <div class="pop-help">Marca múltiples opciones</div>
        <div id="listProv" class="list"></div>
      </div>
    </div>
    <div class="pop-wrap">
      <button id="btnDist" class="btn">Distrito Ejec ▾</button>
      <div id="popDist" class="popover" role="dialog" aria-label="Distrito (ejecutora)">
        <div class="pop-title">Distrito (ejecutora)</div>
        <div class="pop-help">Marca múltiples opciones</div>
        <div id="listDist" class="list"></div>
      </div>
    </div>
    <button id="applyBtn" class="btn btn-primary">Aplicar a líneas</button>
    <button id="clearBtn" class="btn">Limpiar</button>
  </div>

  <div id="chart"><div id="loading">Cargando datos…</div></div>
  <div id="err"></div>
</div>

<script>
(function(){
  // ===== Servicio / tabla =====
  const SERVICE = "https://portalgis.vivienda.gob.pe/servergis/rest/services/OGEI/Mapa_Inversiones_MEF/MapServer";
  const TABLE_ID = 3;
  const tableUrl = SERVICE + "/" + TABLE_ID;

  // ===== Campos =====
  const F = {
    anio:"ano_eje", pim:"monto_pim", dev:"monto_devengado", funcion:"funcion_nombre",
    dpto:"departamento_ejecutora_nombre", prov:"provincia_ejecutora_nombre", dist:"distrito_ejecutora_nombre"
  };

  // ===== Títulos externos =====
  const TITLE_LINE = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones";
  const TITLE_DEPT = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones según departamento ejecutora";
  const TITLE_PROV = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones según provincia ejecutora";
  const TITLE_DIST = "Montos Pim y Devengado para inversiones en saneamiento a nivel nacional en millones según distrito ejecutora";

  // ===== Formatos =====
  const nf1    = new Intl.NumberFormat("es-PE", { minimumFractionDigits:1, maximumFractionDigits:1 });
  const nf2cur = new Intl.NumberFormat("es-PE", { style:"currency", currency:"PEN", minimumFractionDigits:2, maximumFractionDigits:2 });
  const formatAxisShort = (v)=>{
    if(v == null || isNaN(v)) return "";
    const abs = Math.abs(v);
    if(abs >= 1_000_000) return "S/ " + nf1.format(v/1_000_000) + " mill";
    if(abs >= 1_000)     return "S/ " + nf1.format(v/1_000) + " mil";
    return "S/ " + nf1.format(v);
  };
  const formatLabelNoSuffix = (v)=>{
    if(v == null || isNaN(v)) return "";
    const abs = Math.abs(v);
    if(abs >= 1_000_000) return "S/ " + nf1.format(v/1_000_000);
    if(abs >= 1_000)     return "S/ " + nf1.format(v/1_000);
    return "S/ " + nf1.format(v);
  };

  // ===== Paleta =====
  const BASE_HEX = "#2F4858";
  function hexToHsl(hex){
    const m=hex.replace('#','');
    const r=parseInt(m.slice(0,2),16)/255, g=parseInt(m.slice(2,4),16)/255, b=parseInt(m.slice(4,6),16)/255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2;
    if(max===min){h=s=0;}
    else{ const d=max-min; s=l>0.5? d/(2-max-min) : d/(max+min);
      switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;} h/=6; }
    return {h:Math.round(h*360), s:Math.round(s*100), l:Math.round(l*100)};
  }
  const baseHSL = hexToHsl(BASE_HEX);
  const hsl = (h,s,l,a=1)=>`hsla(${h} ${s}% ${l}% / ${a})`;
  const cPim = hsl(baseHSL.h, baseHSL.s, Math.min(85, baseHSL.l + 10));
  const cDev = hsl(baseHSL.h, baseHSL.s, Math.max(18, baseHSL.l - 8));

  // ===== Util =====
  const $err = document.getElementById('err');
  const $loading = document.getElementById('loading');
  const $title = document.getElementById('topTitle');
  function setTopTitle(t){ $title.textContent = t; }
  function qs(url, params){ return url + "?" + new URLSearchParams(params).toString(); }
  async function getJSON(url, params={}, timeoutMs=30000){
    const u = qs(url, params);
    const ctrl = new AbortController();
    const to = setTimeout(()=>ctrl.abort(), timeoutMs);
    let res;
    try{ res = await fetch(u, { signal: ctrl.signal, mode:'cors', credentials:'omit' }); }
    finally{ clearTimeout(to); }
    if(!res.ok) throw new Error(`HTTP ${res.status} al consultar ${u}`);
    const data = await res.json();
    if(data.error) throw new Error((data.error && data.error.message) || "Error en respuesta del servicio");
    return { data, url: u };
  }
  const esc = (v)=> String(v).replace(/'/g,"''");

  // ===== Mapeo especial CALLAO =====
  const mapDeptDisplay = (name)=>{
    const t = String(name||'').trim().toUpperCase();
    if(t === 'PROVINCIA CONSTITUCIONAL DEL CALLAO') return 'CALLAO';
    return String(name||'');
  };
  const mapDeptToOriginal = (display)=>{
    const t = String(display||'').trim().toUpperCase();
    if(t === 'CALLAO') return 'PROVINCIA CONSTITUCIONAL DEL CALLAO';
    return display;
  };

  // ===== Estado de filtros =====
  let selDept = new Set();   // valores DISPLAY
  let selProv = new Set();
  let selDist = new Set();

  // ===== ECharts base =====
  const chart = echarts.init(document.getElementById('chart'));
  window.addEventListener('resize', ()=>chart.resize());

  const ICON_SOLID  = 'path://M2,9 L26,9 L26,11 L2,11 Z';
  const ICON_DASHED = 'path://M2,9 L8,9 L8,11 L2,11 Z M10,9 L16,9 L16,11 L10,11 Z M18,9 L24,9 L24,11 L18,11 Z';

  const baseOption = {
    backgroundColor:'#ffffff',
    grid:{ left:96, right:40, top:110, bottom:90, containLabel:true },
    title: [
      { left:'center', top:10, text:'', textStyle:{ fontSize:16, fontWeight:700, color:'#111827' } },
      { left:'center', top:36, text:'', textStyle:{ fontSize:12, fontWeight:500, color:'#6b7280' } }
    ],
    legend:{
      top:64, left:'center',
      itemWidth:26, itemHeight:10,
      textStyle:{ fontSize:12 },
      data:[ { name:'PIM', icon: ICON_DASHED }, { name:'Devengado', icon: ICON_SOLID } ] // TRAZO para líneas
    },
    tooltip:{
      trigger:'axis',
      axisPointer:{ type:'line' },
      formatter:(params)=>{
        const x = params?.[0]?.axisValue ?? '';
        const lines = [`<b>${x}</b>`];
        (params||[]).forEach(p=>{
          const v = Number(p.value);
          const safe = Number.isFinite(v) ? v : 0;
          const full = nf2cur.format(safe);
          lines.push(`${p.marker} ${p.seriesName}: <b>${full}</b>`);
        });
        return lines.join('<br/>');
      }
    },
    xAxis:{ type:'category', boundaryGap:true, name:'Años', nameLocation:'middle', nameGap:34, axisTick:{alignWithLabel:true}, axisLabel:{margin:14}, animation:false, data:[] },
    yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v), margin:12 }, splitLine:{show:true}, scale:true },
    animation:true,
    animationDuration:1600,
    animationDurationUpdate:1600,
    series:[]
  };
  chart.setOption(baseOption);

  // ===== Popovers (selección funcional) =====
  const btnDept = document.getElementById('btnDept');
  const btnProv = document.getElementById('btnProv');
  const btnDist = document.getElementById('btnDist');
  const popDept = document.getElementById('popDept');
  const popProv = document.getElementById('popProv');
  const popDist = document.getElementById('popDist');
  const listDept = document.getElementById('listDept');
  const listProv = document.getElementById('listProv');
  const listDist = document.getElementById('listDist');

  function closeAllPopovers(){ [popDept,popProv,popDist].forEach(p=>p.classList.remove('open')); }
  // no cierres al interactuar dentro
  [popDept,popProv,popDist].forEach(p=>{
    ['mousedown','click','pointerdown'].forEach(ev=>{
      p.addEventListener(ev, e=>{ e.stopPropagation(); }, true);
    });
  });
  // toggle
  btnDept.addEventListener('click', (e)=>{ e.stopPropagation(); const was=popDept.classList.contains('open'); closeAllPopovers(); if(!was) popDept.classList.add('open'); });
  btnProv.addEventListener('click', (e)=>{ e.stopPropagation(); const was=popProv.classList.contains('open'); closeAllPopovers(); if(!was) popProv.classList.add('open'); });
  btnDist.addEventListener('click', (e)=>{ e.stopPropagation(); const was=popDist.classList.contains('open'); closeAllPopovers(); if(!was) popDist.classList.add('open'); });
  document.addEventListener('click', ()=>closeAllPopovers());
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAllPopovers(); });

  // ===== Render helpers =====
  function renderOptions(container, values, selectedSet, prefix){
    container.innerHTML = "";
    values.forEach((val, idx)=>{
      const id = `${prefix}_${idx}`;
      const wrap = document.createElement('label');
      wrap.className = 'opt';
      wrap.setAttribute('for', id);
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = id;
      input.checked = selectedSet.has(val);
      input.addEventListener('change', (e)=>{
        if(e.target.checked) selectedSet.add(val); else selectedSet.delete(val);
        // cascada: si cambian departamentos, refrescar provincias y distritos; si cambian provincias, refrescar distritos.
        if(prefix==='dept'){ refreshProvinces(); refreshDistricts(); }
        if(prefix==='prov'){ refreshDistricts(); }
      });
      const text = document.createElement('span');
      text.textContent = val;
      wrap.appendChild(input);
      wrap.appendChild(text);
      container.appendChild(wrap);
    });
  }

  // ===== Carga de listas (distintos) =====
  async function fetchDistinct(field, whereExtra){
    const res = await getJSON(tableUrl + "/query", {
      where: whereExtra || "1=1",
      returnGeometry: "false",
      groupByFieldsForStatistics: field,
      outStatistics: JSON.stringify([{statisticType:"count", onStatisticField: field, outStatisticFieldName:"c"}]),
      orderByFields: field + " ASC",
      f: "json",
      cacheHint: "true",
      resultType: "standard"
    });
    const feats = res.data?.features || [];
    return feats
      .map(f => (f.attributes && f.attributes[field]))
      .filter(v => v!=null && String(v).trim()!=='')
      .map(v => field===F.dpto ? mapDeptDisplay(v) : String(v))
      .filter((v,i,arr)=>arr.indexOf(v)===i);
  }

  function buildWhereForLines(){
    let where = `(${F.anio} IS NOT NULL) AND (UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO')) AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL)`;
    if(selDept.size){
      // convertir DISPLAY -> original para la consulta
      const arr = [...selDept].map(mapDeptToOriginal).map(v=>`'${esc(v)}'`);
      where += ` AND UPPER(${F.dpto}) IN (${arr.map(s=>`UPPER(${s})`).join(",")})`;
    }
    if(selProv.size){
      const arr = [...selProv].map(v=>`'${esc(v)}'`);
      where += ` AND UPPER(${F.prov}) IN (${arr.map(s=>`UPPER(${s})`).join(",")})`;
    }
    if(selDist.size){
      const arr = [...selDist].map(v=>`'${esc(v)}'`);
      where += ` AND UPPER(${F.dist}) IN (${arr.map(s=>`UPPER(${s})`).join(",")})`;
    }
    return where;
  }

  // ===== Cargar listas con cascada =====
  async function refreshDepartments(){
    const vals = await fetchDistinct(F.dpto, "1=1");
    renderOptions(listDept, vals, selDept, 'dept');
  }
  async function refreshProvinces(){
    let where = "1=1";
    if(selDept.size){
      const arr = [...selDept].map(mapDeptToOriginal).map(v=>`'${esc(v)}'`);
      where += ` AND UPPER(${F.dpto}) IN (${arr.map(s=>`UPPER(${s})`).join(",")})`;
    }
    const vals = await fetchDistinct(F.prov, where);
    // si lo seleccionado ya no existe, quítalo
    selProv = new Set([...selProv].filter(v=>vals.includes(v)));
    renderOptions(listProv, vals, selProv, 'prov');
  }
  async function refreshDistricts(){
    let where = "1=1";
    if(selDept.size){
      const arr = [...selDept].map(mapDeptToOriginal).map(v=>`'${esc(v)}'`);
      where += ` AND UPPER(${F.dpto}) IN (${arr.map(s=>`UPPER(${s})`).join(",")})`;
    }
    if(selProv.size){
      const arr = [...selProv].map(v=>`'${esc(v)}'`);
      where += ` AND UPPER(${F.prov}) IN (${arr.map(s=>`UPPER(${s})`).join(",")})`;
    }
    const vals = await fetchDistinct(F.dist, where);
    selDist = new Set([...selDist].filter(v=>vals.includes(v)));
    renderOptions(listDist, vals, selDist, 'dist');
  }

  // ===== Leyenda de rutas (encima de leyenda de series) =====
  function currentScopeLabel(){
    const d = [...selDept], p = [...selProv], t = [...selDist];
    if(t.length===1 && p.length===1 && d.length===1) return `${d[0]} — ${p[0]} — ${t[0]}`;
    if(p.length===1 && d.length===1) return `${d[0]} — ${p[0]}`;
    if(d.length===1) return d[0];
    return "NACIONAL";
    // (si hay múltiples selecciones en cualquiera, optamos por el nivel más alto)
  }

  // ===== Vista Línea =====
  async function loadLine(){
    setTopTitle(TITLE_LINE);
    $loading.style.display = 'flex';

    const outStats = JSON.stringify([
      { statisticType:"sum", onStatisticField:F.pim, outStatisticFieldName:"sum_pim" },
      { statisticType:"sum", onStatisticField:F.dev, outStatisticFieldName:"sum_dev" }
    ]);

    const res = await getJSON(tableUrl + "/query", {
      where: buildWhereForLines(),
      groupByFieldsForStatistics: F.anio,
      outStatistics: outStats,
      orderByFields: `${F.anio} ASC`,
      returnGeometry: "false", f: "json", resultType:"standard", cacheHint:"true"
    });

    const feats = res.data?.features || [];
    if(!feats.length) throw new Error("La consulta no devolvió filas.");

    const rows = feats.map(f=>({
      anio: Number(f.attributes[F.anio]),
      pim : Number(f.attributes.sum_pim || 0),
      dev : Number(f.attributes.sum_dev || 0)
    })).filter(r=>!isNaN(r.anio)).sort((a,b)=>a.anio-b.anio);

    const years = rows.map(r=>String(r.anio));
    const dataPim = rows.map(r=>r.pim);
    const dataDev = rows.map(r=>r.dev);

    chart.clear();
    chart.setOption({
      ...baseOption,
      title: [
        { ...baseOption.title[0], text: currentScopeLabel() }, // <- aquí va NACIONAL / filtros
        { ...baseOption.title[1], text: "" }
      ],
      xAxis:{ ...baseOption.xAxis, data: years, name:'Años' },
      yAxis:{ ...baseOption.yAxis, name:'Monto (S/)' },
      legend:{ ...baseOption.legend }, // trazo para líneas
      series:[
        { name:'PIM', type:'line', smooth:true, showSymbol:true, symbol:'circle', symbolSize:8,
          lineStyle:{ width:2, color:cPim, type:'dashed' }, itemStyle:{ color:cPim }, emphasis:{ focus:'series', scale:false }, clip:true,
          label:{ show:true, position:'top', distance:6, fontSize:11, color:'#111827',
                  formatter:(p)=> (p.value==null||isNaN(p.value)) ? '' : formatLabelNoSuffix(+p.value) },
          labelLayout:{ hideOverlap:true },
          data:dataPim },
        { name:'Devengado', type:'line', smooth:true, showSymbol:true, symbol:'circle', symbolSize:8,
          lineStyle:{ width:2, color:cDev, type:'solid' }, itemStyle:{ color:cDev }, emphasis:{ focus:'series', scale:false }, clip:true,
          label:{ show:true, position:'top', distance:6, fontSize:11, color:'#111827',
                  formatter:(p)=> (p.value==null||isNaN(p.value)) ? '' : formatLabelNoSuffix(+p.value) },
          labelLayout:{ hideOverlap:true },
          data:dataDev }
      ],
      graphic: []
    });

    // clic a barras (drilldown) sigue igual que tu versión previa:
    chart.off('click');
    chart.on('click', (ev)=>{
      if(ev.componentType==='series' && ev.seriesType==='line'){
        const year = String(ev.name);
        drillStack = [];
        loadBarsDept({ year }).catch(showErr);
      }
    });

    $loading.style.display = 'none';
    $err.style.display = 'none';
    $err.textContent = '';
  }

  // ===== Botón volver y drillstack (se mantiene) =====
  function backGraphic(color, onClick){
    const stroke = color;
    return [{
      type: 'group', left: 10, top: 10, z: 100, bounding: 'all', cursor: 'pointer', onclick: onClick,
      children: [
        {type:'circle', shape:{cx:18, cy:18, r:18}, style:{fill:'#fff', stroke:stroke, lineWidth:2, shadowBlur:6, shadowColor:'rgba(0,0,0,.08)'}},
        {type:'polyline', shape:{points:[[22,10],[14,18],[22,26]]}, style:{stroke:stroke, lineWidth:3, lineCap:'round', lineJoin:'round'}}
      ]
    }];
  }
  let drillStack = [];
  function pushBack(fn){ drillStack.push(fn); }
  async function goBack(){
    if(!drillStack.length){ await loadLine(); return; }
    const fn = drillStack.pop(); await fn();
  }
  document.onkeydown = async (e)=>{ if(e.key==='Escape') goBack(); };

  // ===== Barras por Departamento / Provincia / Distrito (sin cambios de lógica) =====
  // (Se dejan igual a tu versión anterior para no alargar: solo afectan al drilldown y no a los filtros de la línea)
  async function barsQuery(groupField, where){
    const outStats = JSON.stringify([
      { statisticType:"sum", onStatisticField:F.pim, outStatisticFieldName:"sum_pim" },
      { statisticType:"sum", onStatisticField:F.dev, outStatisticFieldName:"sum_dev" }
    ]);
    const res = await getJSON(tableUrl + "/query", {
      where, groupByFieldsForStatistics: groupField, outStatistics: outStats,
      orderByFields: `sum_pim DESC`,
      returnGeometry:"false", f:"json", resultType:"standard", cacheHint:"true"
    });
    return res.data?.features || [];
  }

  function spacerIfNeeded(x, yP, yD){
    const need = x.length >= 6;
    if(!need) return { xPlot:x, yPPlot:yP, yDPlot:yD };
    return { xPlot:[' ',...x], yPPlot:[null,...yP], yDPlot:[null,...yD] };
  }

  async function loadBarsDept({ year }){
    setTopTitle(TITLE_DEPT);
    $loading.style.display = 'flex';
    const feats = await barsQuery(F.dpto,
      `${F.anio}=${Number(year)} AND UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO') AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL) AND ${F.dpto} IS NOT NULL`
    );
    const rows = feats.map(f=>({
      name: mapDeptDisplay(f.attributes[F.dpto]),
      pim : Number(f.attributes.sum_pim || 0),
      dev : Number(f.attributes.sum_dev || 0)
    })).filter(r=>r.name).sort((a,b)=>b.pim-a.pim);

    const x = rows.map(r=>r.name), yP = rows.map(r=>r.pim), yD = rows.map(r=>r.dev);
    const {xPlot,yPPlot,yDPlot} = spacerIfNeeded(x,yP,yD);

    chart.clear();
    chart.setOption({
      backgroundColor:'#fff',
      title: [{left:'center', top:10, text:`${year}`, textStyle:{ fontSize:18, fontWeight:700, color:'#111827' }}, {left:'center', top:36, text:``, textStyle:{fontSize:12,color:'#6b7280'}}],
      grid:{ left:96, right:40, top:110, bottom:110, containLabel:true },
      legend:{ top:64, left:'center', itemWidth:18, itemHeight:10, icon:'roundRect', textStyle:{fontSize:12}, data:['PIM','Devengado'] },
      tooltip: baseOption.tooltip,
      xAxis:{ type:'category', data:xPlot, axisLabel:{ interval:0, rotate:(x.length>18?40:(x.length>12?25:0)), margin:10 } },
      yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v) }, scale:true },
      series:[
        { name:'PIM', type:'bar', data:yPPlot, itemStyle:{ color:cPim },
          label:{ show:true, position:'top', rotate:90, align:'left', verticalAlign:'middle', distance:8,
                  formatter:(p)=> String(p.name).trim()==='' ? '' : formatLabelNoSuffix(+p.value) } },
        { name:'Devengado', type:'bar', data:yDPlot, itemStyle:{ color:cDev },
          label:{ show:true, position:'top', rotate:90, align:'left', verticalAlign:'middle', distance:8,
                  formatter:(p)=> String(p.name).trim()==='' ? '' : formatLabelNoSuffix(+p.value) } }
      ],
      animation:true, animationDuration:1200,
      graphic: backGraphic(cDev, ()=>goBack())
    });

    chart.off('click');
    chart.on('click', (ev)=>{
      if(ev.componentType==='series' && ev.seriesType==='bar'){
        if(String(ev.name).trim()==='') return;
        const depDisplay = ev.name;
        const depOriginal = mapDeptToOriginal(depDisplay);
        pushBack(()=>loadBarsDept({ year }));
        loadBarsProv({ year, depDisplay, depOriginal }).catch(showErr);
      }
    });
    $loading.style.display = 'none';
  }

  async function loadBarsProv({ year, depDisplay, depOriginal }){
    setTopTitle(TITLE_PROV);
    $loading.style.display = 'flex';
    const where =
      `${F.anio}=${Number(year)} AND UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO') `+
      `AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL) AND ${F.prov} IS NOT NULL `+
      `AND UPPER(${F.dpto})=UPPER('${esc(depOriginal)}')`;
    const feats = await barsQuery(F.prov, where);

    const rows = feats.map(f=>({ name: String(f.attributes[F.prov]), pim:Number(f.attributes.sum_pim||0), dev:Number(f.attributes.sum_dev||0) }))
                      .filter(r=>r.name).sort((a,b)=>b.pim-a.pim);
    const x = rows.map(r=>r.name), yP = rows.map(r=>r.pim), yD = rows.map(r=>r.dev);
    const {xPlot,yPPlot,yDPlot} = spacerIfNeeded(x,yP,yD);

    chart.clear();
    chart.setOption({
      backgroundColor:'#fff',
      title: [{left:'center', top:10, text:`${depDisplay} — ${year}`, textStyle:{ fontSize:18, fontWeight:700, color:'#111827' }}, {left:'center', top:36, text:``, textStyle:{fontSize:12,color:'#6b7280'}}],
      grid:{ left:96, right:40, top:110, bottom:110, containLabel:true },
      legend:{ top:64, left:'center', itemWidth:18, itemHeight:10, icon:'roundRect', textStyle:{fontSize:12}, data:['PIM','Devengado'] },
      tooltip: baseOption.tooltip,
      xAxis:{ type:'category', data:xPlot, axisLabel:{ interval:0, rotate:(x.length>18?40:(x.length>12?25:0)), margin:10 } },
      yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v) }, scale:true },
      series:[
        { name:'PIM', type:'bar', data:yPPlot, itemStyle:{ color:cPim }, label:{ show:true, position:'top', rotate:90, align:'left', verticalAlign:'middle', distance:8, formatter:(p)=> String(p.name).trim()==='' ? '' : formatLabelNoSuffix(+p.value) } },
        { name:'Devengado', type:'bar', data:yDPlot, itemStyle:{ color:cDev }, label:{ show:true, position:'top', rotate:90, align:'left', verticalAlign:'middle', distance:8, formatter:(p)=> String(p.name).trim()==='' ? '' : formatLabelNoSuffix(+p.value) } }
      ],
      animation:true, animationDuration:1200,
      graphic: backGraphic(cDev, ()=>goBack())
    });

    chart.off('click');
    chart.on('click', (ev)=>{
      if(ev.componentType==='series' && ev.seriesType==='bar'){
        if(String(ev.name).trim()==='') return;
        const prov = ev.name;
        pushBack(()=>loadBarsProv({ year, depDisplay, depOriginal }));
        loadBarsDist({ year, depDisplay, depOriginal, prov }).catch(showErr);
      }
    });
    $loading.style.display = 'none';
  }

  async function loadBarsDist({ year, depDisplay, depOriginal, prov }){
    setTopTitle(TITLE_DIST);
    $loading.style.display = 'flex';
    const where =
      `${F.anio}=${Number(year)} AND UPPER(${F.funcion}) IN ('SANEAMIENTO','SALUD Y SANEAMIENTO') `+
      `AND (${F.pim} IS NOT NULL OR ${F.dev} IS NOT NULL) AND ${F.dist} IS NOT NULL `+
      `AND UPPER(${F.dpto})=UPPER('${esc(depOriginal)}') AND UPPER(${F.prov})=UPPER('${esc(prov)}')`;
    const feats = await barsQuery(F.dist, where);

    const rows = feats.map(f=>({ name: String(f.attributes[F.dist]), pim:Number(f.attributes.sum_pim||0), dev:Number(f.attributes.sum_dev||0) }))
                      .filter(r=>r.name).sort((a,b)=>b.pim-a.pim);
    const x = rows.map(r=>r.name), yP = rows.map(r=>r.pim), yD = rows.map(r=>r.dev);
    const {xPlot,yPPlot,yDPlot} = spacerIfNeeded(x,yP,yD);

    chart.clear();
    chart.setOption({
      backgroundColor:'#fff',
      title: [{left:'center', top:10, text:`${depDisplay} — ${prov} — ${year}`, textStyle:{ fontSize:18, fontWeight:700, color:'#111827' }}, {left:'center', top:36, text:``, textStyle:{fontSize:12,color:'#6b7280'}}],
      grid:{ left:96, right:40, top:110, bottom:110, containLabel:true },
      legend:{ top:64, left:'center', itemWidth:18, itemHeight:10, icon:'roundRect', textStyle:{fontSize:12}, data:['PIM','Devengado'] },
      tooltip: baseOption.tooltip,
      xAxis:{ type:'category', data:xPlot, axisLabel:{ interval:0, rotate:(x.length>18?40:(x.length>12?25:0)), margin:10 } },
      yAxis:{ type:'value', name:'Monto (S/)', axisLabel:{ formatter:v=>formatAxisShort(v) }, scale:true },
      series:[
        { name:'PIM', type:'bar', data:yPPlot, itemStyle:{ color:cPim }, label:{ show:true, position:'top', rotate:90, align:'left', verticalAlign:'middle', distance:8, formatter:(p)=> String(p.name).trim()==='' ? '' : formatLabelNoSuffix(+p.value) } },
        { name:'Devengado', type:'bar', data:yDPlot, itemStyle:{ color:cDev }, label:{ show:true, position:'top', rotate:90, align:'left', verticalAlign:'middle', distance:8, formatter:(p)=> String(p.name).trim()==='' ? '' : formatLabelNoSuffix(+p.value) } }
      ],
      animation:true, animationDuration:1200,
      graphic: backGraphic(cDev, ()=>goBack())
    });

    chart.off('click');
    $loading.style.display = 'none';
  }

  // ===== Botones Aplicar / Limpiar =====
  document.getElementById('applyBtn').addEventListener('click', async ()=>{
    closeAllPopovers();
    try{ await loadLine(); }catch(e){ showErr(e); }
  });
  document.getElementById('clearBtn').addEventListener('click', async ()=>{
    selDept.clear(); selProv.clear(); selDist.clear();
    await refreshDepartments(); await refreshProvinces(); await refreshDistricts();
    try{ await loadLine(); }catch(e){ showErr(e); }
  });

  // ===== Errores =====
  function showErr(e){
    $loading.style.display = 'none';
    $err.style.display = 'block';
    $err.textContent = "Error: " + (e && e.message ? e.message : e);
    console.error(e);
  }

  // ===== Init =====
  (async function run(){
    try{
      $loading.style.display = 'flex';
      await refreshDepartments();
      await refreshProvinces();
      await refreshDistricts();
      await loadLine();
      $loading.style.display = 'none';
      $err.style.display = 'none';
    }catch(e){ showErr(e); }
  })();
})();
</script>
</body>
</html>

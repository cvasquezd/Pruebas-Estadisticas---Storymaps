<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bubble chart dinámico — Gasto vs Acceso Agua (ENAPRES como tamaño)</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    #chart{height:100vh;width:100vw}
  </style>
</head>
<body>
<div id="chart"></div>

<script>
const SERVICE_BASE = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/Mapa_coropletico_2/FeatureServer";

/* ==== IDs de capas (ajusta si cambian) ==== 
   Antes: LYR_X=5 (acceso), LYR_Y=3 (gasto) => se cruzaban con las etiquetas.
   Ahora lo hacemos explícito: */
const LYR_GASTO  = 3;  // S/
const LYR_ACCESO = 5;  // Población con acceso a agua
const LYR_SIZE   = 4;  // Tamaño de burbuja (población ENAPRES, miles)

const YEAR_START = 2011;
const YEAR_END   = 2024;

const REGION_COLS = [
  { key:'amazonas', display:'Amazonas' },
  { key:'ancash', display:'Áncash' },
  { key:'apurimac', display:'Apurímac' },
  { key:'arequipa', display:'Arequipa' },
  { key:'ayacucho', display:'Ayacucho' },
  { key:'cajamarca', display:'Cajamarca' },
  { key:'provincia_constitucional_del_ca', display:'Callao' },
  { key:'cusco', display:'Cusco' },
  { key:'huancavelica', display:'Huancavelica' },
  { key:'huanuco', display:'Huánuco' },
  { key:'ica', display:'Ica' },
  { key:'junin', display:'Junín' },
  { key:'la_libertad', display:'La Libertad' },
  { key:'lambayeque', display:'Lambayeque' },
  { key:'lima', display:'Lima' },
  { key:'loreto', display:'Loreto' },
  { key:'madre_de_dios', display:'Madre de Dios' },
  { key:'moquegua', display:'Moquegua' },
  { key:'pasco', display:'Pasco' },
  { key:'piura', display:'Piura' },
  { key:'puno', display:'Puno' },
  { key:'san_martin', display:'San Martín' },
  { key:'tacna', display:'Tacna' },
  { key:'tumbes', display:'Tumbes' },
  { key:'ucayali', display:'Ucayali' }
];

const chart = echarts.init(document.getElementById('chart'));

function qs(url, params) {
  return url + "?" + new URLSearchParams(params).toString();
}
async function fetchTable(layerId) {
  const url = qs(`${SERVICE_BASE}/${layerId}/query`, {
    where: "1=1",
    outFields: "*",
    returnGeometry: "false",
    orderByFields: "anio ASC",
    f: "json"
  });
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} al consultar layer ${layerId}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error.message || `Error del servicio en layer ${layerId}`);
  const feats = json.features || [];
  const byYear = new Map();
  for (const f of feats) {
    const a = (f.attributes || {});
    const yrRaw = a.anio;
    const yr = typeof yrRaw === 'string' ? parseInt(yrRaw, 10) : Number(yrRaw);
    if (Number.isFinite(yr)) byYear.set(yr, a);
  }
  return byYear;
}
function extent(arr) {
  let min = +Infinity, max = -Infinity;
  for (const v of arr) {
    if (Number.isFinite(v)) { if (v < min) min = v; if (v > max) max = v; }
  }
  if (!Number.isFinite(min) || !Number.isFinite(max)) return [0,1];
  if (min === max) return [0, max || 1];
  return [min, max];
}
function makeSizeFn(values) {
  const [mn, mx] = extent(values);
  return function sizeFn(x) {
    const v = Math.max(0, Number(x)||0);
    const t = mx > 0 ? (v / mx) : 0;
    return (Math.sqrt(t) + 0.10) * 60;
  };
}

(async function run(){
  try {
    chart.showLoading({ text: 'Cargando datos…' });
    // Cargamos por concepto explícito
    const [gastoByYear, accesoByYear, sizeByYear] = await Promise.all([
      fetchTable(LYR_GASTO),
      fetchTable(LYR_ACCESO),
      fetchTable(LYR_SIZE)
    ]);

    const years = [];
    for (let y = YEAR_START; y <= YEAR_END; y++) years.push(y);

    // Recolectamos para escalas
    const allGastos = [];
    const allSizes = [];
    years.forEach(y => {
      const rowG = gastoByYear.get(y) || {};
      const rowS = sizeByYear.get(y) || {};
      for (const {key} of REGION_COLS) {
        const vG = Number(rowG[key]);
        const vS = Number(rowS[key]);
        if (Number.isFinite(vG) && vG > 0) allGastos.push(vG); // log necesita >0
        if (Number.isFinite(vS)) allSizes.push(vS);
      }
    });
    const sizeFn = makeSizeFn(allSizes);

    // Escala eje X (Gasto)
    let [minX, maxX] = extent(allGastos);
    // Asegurar mínimo positivo para escala log
    if (!(minX > 0)) minX = Math.min(...allGastos.filter(v=>v>0)) || 1;
    if (!(maxX > 0)) maxX = 1;

    const options = [];
    for (const y of years) {
      const rowG = gastoByYear.get(y) || {};
      const rowA = accesoByYear.get(y) || {};
      const rowS = sizeByYear.get(y) || {};

      const points = REGION_COLS.map(({key, display}) => {
        const gasto  = Number(rowG[key]);
        const acceso = Number(rowA[key]);
        const tam    = Number(rowS[key]);
        return [gasto, acceso, tam, display];
      }).filter(d => Number.isFinite(d[0]) && d[0] > 0 && Number.isFinite(d[1]));

      options.push({
        title: { show: true, text: String(y) },
        series: [{
          name: String(y),
          type: 'scatter',
          data: points,
          itemStyle: { opacity: 0.85 },
          symbolSize: (val) => sizeFn(val[2]),
          label: {
            show: true,
            formatter: p => p.value[3],
            position: 'right',
            fontSize: 10,
            color: '#333'
          }
        }]
      });
    }

    const categories = REGION_COLS.map(r => r.display);
    const colorPalette = ['#51689b','#ce5c5c','#fbc357','#8fbf8f','#659d84','#fb8e6a','#c77288','#786090','#91c4c5','#6890ba'];
    const regionColors = [];
    while (regionColors.length < categories.length) regionColors.push(...colorPalette);

    const nf = new Intl.NumberFormat('es-PE');

    const option = {
      baseOption: {
        timeline: {
          axisType: 'category',
          orient: 'vertical',
          autoPlay: true,
          inverse: true,
          playInterval: 1200,
          right: 0,
          top: 20,
          bottom: 20,
          width: 55,
          symbol: 'none',
          checkpointStyle: { borderWidth: 2 },
          controlStyle: { showNextBtn: false, showPrevBtn: false },
          data: years
        },
        title: [
          {
            text: years[0],
            textAlign: 'center',
            left: '63%',
            top: '55%',
            textStyle: { fontSize: 80, fontWeight: 600, color: '#e5e7eb' }
          },
          {
            text: 'Gasto (S/) vs Población con acceso a agua — tamaño: Población (miles)',
            left: 'center',
            top: 8,
            textStyle: { fontWeight: '600', fontSize: 16 }
          }
        ],
        tooltip: {
          padding: 6,
          borderWidth: 1,
          formatter: function (obj) {
            const v = obj.value; // [gasto, acceso, tamaño, región]
            return `
              <b>${v[3]}</b><br>
              Gasto (S/): <b>${nf.format(v[0])}</b><br>
              Acceso a agua: <b>${nf.format(v[1])}</b><br>
              Población (miles): <b>${nf.format(v[2])}</b>
            `;
          }
        },
        grid: { top: 80, left: 40, right: 110, bottom: 40, containLabel: true },
        xAxis: {
          type: 'log',
          name: 'Gasto (S/)',
          min: minX * 0.9,
          max: maxX * 1.1,
          nameGap: 25,
          nameLocation: 'middle',
          nameTextStyle: { fontSize: 14 },
          splitLine: { show: false },
          axisLabel: { formatter: (v) => nf.format(v) }
        },
        yAxis: {
          type: 'value',
          name: 'Población con acceso al agua',
          nameTextStyle: { fontSize: 14 },
          splitLine: { show: true },
          axisLabel: { formatter: (v) => nf.format(v) }
        },
        visualMap: [{
          show: false,
          dimension: 3,
          categories: categories,
          inRange: { color: regionColors }
        }],
        series: [{
          type: 'scatter',
          data: [],
          symbolSize: (val) => sizeFn(val[2]),
          label: {
            show: true,
            formatter: p => p.value[3],
            position: 'right',
            fontSize: 10,
            color: '#333'
          }
        }],
        animationDurationUpdate: 1000,
        animationEasingUpdate: 'quinticInOut'
      },
      options
    };

    chart.hideLoading();
    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());
  } catch (err) {
    console.error(err);
    chart.hideLoading();
    chart.setOption({
      title: { text:'Error al cargar datos', left:'center' },
      graphic: {
        type:'text', left:'center', top:'middle',
        style:{ text: (err && err.message) ? err.message : 'Fallo de carga.\nRevisa URL, permisos (token) o campos.', fontSize: 14 }
      }
    });
  }
})();
</script>
</body>
</html>

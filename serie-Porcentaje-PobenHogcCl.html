<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Porcentaje de hogares con presencia de cloro residual libre ≥ 0.5 mg/L, por ámbito</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#fafafa; --shadow:0 6px 28px rgba(0,0,0,.08); }
    html,body{height:70vh;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    h1{font-weight:700;font-size:20px;margin:0 0 6px;text-align:center}
    .sub{color:var(--muted);font-size:12px;margin:0 0 14px;text-align:center}
    #chart{height:70vh;min-height:460px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);position:relative}
    #loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:#6b7280}
    #err{margin-top:10px;color:#b91c1c;font-size:12px;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
<div id="wrap">
  <h1>Porcentaje de hogares con presencia de cloro residual libre ≥ 0.5 mg/L, por ámbito</h1>
  <p class="sub">Fuente: ENAHO</p>
  <div id="chart"><div id="loading">Cargando datos…</div></div>
  <div id="err"></div>
</div>

<script>
(function(){
  // ======= Config =======
  const SERVICE = "https://pportalgis.vivienda.gob.pe/phtserver/rest/services/Hosted/Mapa_coropletico_2/FeatureServer";
  const TARGET_TABLE_NAME = "bd_geovivienda.ogei.tb_indicadores_serie";
  const INDICADOR_OBJ = "Ind_12_2";      // ajusta si en tu servicio tiene otro casing
  const D_VALORES = "CON ACCESO";
  const REGION_TOTAL = "NACIONAL";

  // ======= Helpers =======
  const nf1 = new Intl.NumberFormat('es-PE', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
  const norm = (s)=> String(s||'').replace(/\s+/g,' ').trim();
  const up   = (s)=> norm(s).toUpperCase();

  const $err = document.getElementById('err');
  const $loading = document.getElementById('loading');

  function qs(url, params){ return url + "?" + new URLSearchParams(params).toString(); }
  function jsonp(url, params, timeoutMs=20000){
    return new Promise((resolve, reject)=>{
      const cb = "__arcgis_cb_" + Math.random().toString(36).slice(2);
      params = { ...(params||{}), callback: cb };
      const u = qs(url, params);
      const s = document.createElement('script');
      let settled=false;
      const timer = setTimeout(()=>{ if(settled) return; settled=true; cleanup(); reject(new Error("Timeout JSONP: "+u)); }, timeoutMs);
      function cleanup(){ clearTimeout(timer); if(s.parentNode) s.parentNode.removeChild(s); try{ delete window[cb]; }catch(_){ } }
      window[cb] = (data)=>{ if(settled) return; settled=true; cleanup(); resolve({data, url:u}); };
      s.src = u;
      s.onerror = ()=>{ if(settled) return; settled=true; cleanup(); reject(new Error("Error de script JSONP: "+u)); };
      document.head.appendChild(s);
    });
  }
  function resolveFieldName(layerMeta, candidates){
    const fields = (layerMeta && layerMeta.fields) || [];
    const wanted = candidates.map(s => String(s).toLowerCase());
    for(const f of fields){
      const n = (f.name||"").toLowerCase();
      const a = (f.alias||"").toLowerCase();
      if (wanted.includes(n) || (a && wanted.includes(a))) return f.name;
    }
    return null;
  }

  // Colores consistentes
  const BASE_HEX = "#2F4858";
  function hexToHsl(hex){
    const m = hex.replace('#','');
    const r=parseInt(m.slice(0,2),16)/255, g=parseInt(m.slice(2,4),16)/255, b=parseInt(m.slice(4,6),16)/255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2;
    if(max===min){h=s=0;} else {const d=max-min; s=l>0.5? d/(2-max-min) : d/(max+min);
      switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;} h/=6;}
    return {h:Math.round(h*360), s:Math.round(s*100), l:Math.round(l*100)};
  }
  function hsl(h,s,l,a=1){ return `hsla(${h} ${s}% ${l}% / ${a})`; }
  const baseHSL = hexToHsl(BASE_HEX);

  // Flecha de regreso (overlay graphic)
  function backGraphic(color, onClick){
    const stroke = color || '#111827';
    return [{
      type: 'group',
      left: 10, top: 10, z: 100,
      bounding: 'all',
      cursor: 'pointer',
      onclick: onClick,
      children: [
        {type:'circle', shape:{cx:18, cy:18, r:18}, style:{fill:'#fff', stroke:stroke, lineWidth:2, shadowBlur:6, shadowColor:'rgba(0,0,0,.08)'}},
        {type:'polyline', shape:{points:[[22,10],[14,18],[22,26]]}, style:{stroke:stroke, lineWidth:3, lineCap:'round', lineJoin:'round'}}
      ]
    }];
  }

  // ======= Base de gráfico =======
  const chart = echarts.init(document.getElementById('chart'));
  window.addEventListener('resize', ()=>chart.resize());
  const baseOption = {
    backgroundColor: '#ffffff',
    grid: { left: 96, right: 48, top: 74, bottom: 72, containLabel: true },
    legend: { top: 14, left: 'center', itemWidth: 22, itemHeight: 10, icon: 'roundRect', textStyle: { fontSize: 12 } },
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'line' },
      formatter: (params)=>{
        const year = params?.[0]?.axisValue ?? '';
        const lines = [`<b>${year}</b>`];
        (params||[]).forEach(p=>{
          const v = (p.value==null||isNaN(p.value)) ? '—' : `${nf1.format(+p.value)}%`;
          lines.push(`${p.marker} ${p.seriesName}: <b>${v}</b>`);
        });
        return lines.join('<br/>');
      }
    },
    xAxis: { type:'category', boundaryGap:true, name:'Años', nameLocation:'middle', nameGap:34, axisTick:{alignWithLabel:true}, axisLabel:{ margin:14 }, animation:false, data:[] },
    yAxis: { type:'value', name:'%', axisLabel:{ formatter:v=>nf1.format(v), margin:12 }, splitLine:{show:true}, scale:true },
    animation: true,
    animationDuration: 1200,
    animationDurationUpdate: 1200,
    series: [],
    graphic: []
  };
  chart.setOption(baseOption);

  // ======= Estado / metadatos =======
  let tableUrl = null;
  let fields = {};
  async function initMeta(){
    const meta = await jsonp(SERVICE, { f: "pjson" });
    const all = [...(meta.data.tables||[]), ...(meta.data.layers||[])];
    const found =
      all.find(t => t && t.name && up(t.name).includes(up(TARGET_TABLE_NAME))) ||
      all.find(t => t && t.name && up(t.name).includes("TB_INDICADORES_SERIE"));
    if (!found) throw new Error("No se encontró la tabla objetivo en el servicio.");
    tableUrl = SERVICE + "/" + found.id;

    const info = await jsonp(tableUrl, { f:"pjson" });
    fields = {
      anio  : resolveFieldName(info.data, ["anio"]),
      ambito: resolveFieldName(info.data, ["ambito"]),
      valor : resolveFieldName(info.data, ["valor_porcentaje","valor porcentaje","valor_porcentual"]),
      region: resolveFieldName(info.data, ["region"]),
      ind   : resolveFieldName(info.data, ["id_indicador","indicador_id"]),
      dvals : resolveFieldName(info.data, ["d_valores","d valores","descripcion_valor"])
    };
    if(Object.values(fields).some(v=>!v)) throw new Error("Campos requeridos no hallados.");
  }

  // ======= Serie (líneas) para region=NACIONAL =======
  async function loadLine(){
    const {anio, ambito, valor, region, ind, dvals} = fields;

    // Primero coincidencia directa
    let where =
      `${region}='${REGION_TOTAL}' AND ${ind}='${INDICADOR_OBJ}' AND ${dvals}='${D_VALORES}'`;

    let res = await jsonp(tableUrl + "/query", {
      where,
      outFields: [anio,ambito,valor].join(","),
      orderByFields: `${anio} ASC, ${ambito} ASC`,
      returnGeometry: "false",
      f: "json"
    }, 20000);

    let features = (res.data && res.data.features) || [];
    if(!features.length){
      // Reintento robusto con UPPER
      where =
        `UPPER(${region})='${REGION_TOTAL}' AND UPPER(${ind})=UPPER('${INDICADOR_OBJ}') AND UPPER(${dvals})=UPPER('${D_VALORES}')`;
      res = await jsonp(tableUrl + "/query", {
        where,
        outFields: [anio,ambito,valor].join(","),
        orderByFields: `${anio} ASC, ${ambito} ASC`,
        returnGeometry: "false",
        f: "json"
      }, 20000);
      features = (res.data && res.data.features) || [];
    }
    if(!features.length) throw new Error("La consulta no devolvió filas (serie). Verifica id_indicador y d_valores.");

    const raw = features.map(f=>f.attributes)
      .filter(r => r && r[anio] != null && r[ambito] != null && r[valor] != null)
      .map(r => ({ anio: Number(r[anio]), ambito: up(r[ambito]), valor: Number(r[valor]) }));

    // 0..1 -> %
    const maxRaw = Math.max(...raw.map(r=>r.valor));
    const scale = (maxRaw <= 1.5) ? 100 : 1;
    raw.forEach(r => r.valor = r.valor * scale);

    // agregación (ambito, anio)
    const agg = new Map();
    raw.forEach(r=>{
      const key = r.ambito + "|" + r.anio;
      const cur = agg.get(key) || { sum:0, count:0 };
      cur.sum += r.valor; cur.count += 1;
      agg.set(key, cur);
    });
    const rows = Array.from(agg.entries()).map(([key, o])=>{
      const [amb, an] = key.split("|");
      return { ambito: amb, anio: Number(an), valor: o.sum / o.count };
    });

    // Solo NACIONAL/URBANO/RURAL
    const VALID = new Set(['NACIONAL','URBANO','RURAL']);
    const filtered = rows.filter(r => VALID.has(r.ambito));

    const years = Array.from(new Set(filtered.map(r=>r.anio))).sort((a,b)=>a-b).map(String);
    const byAmb = {};
    filtered.forEach(r => { (byAmb[r.ambito] ||= []).push(r); });

    const seriesPrep = [];
    Object.entries(byAmb).forEach(([ambito, arr])=>{
      const m = new Map(arr.map(o=>[String(o.anio), o.valor]));
      const data = years.map(y => (m.has(y) ? Number(m.get(y)) : null));
      const valid = data.filter(v=>v!=null);
      const mean = valid.length ? valid.reduce((a,b)=>a+b,0)/valid.length : 0;
      seriesPrep.push({ name: ambito, data, mean });
    });

    // Orden preferente
    const prefer = ["NACIONAL","URBANO","RURAL"];
    seriesPrep.sort((a,b)=>{
      const ai = prefer.indexOf(a.name), bi = prefer.indexOf(b.name);
      if(ai!==-1 || bi!==-1){
        if(ai===-1) return 1;
        if(bi===-1) return -1;
        return ai-bi;
      }
      return (b.mean||0)-(a.mean||0);
    });

    // Colores/estilos + **ETIQUETAS EN LÍNEAS**
    const n = Math.max(1, seriesPrep.length);
    const minL = Math.max(18, baseHSL.l - 12);
    const maxL = Math.min(85, baseHSL.l + 26);
    const stepL = (i)=> Math.round(minL + (maxL - minL) * (i/(n-1 || 1)));

    const series = seriesPrep.map((s,i)=>{
      const col = hsl(baseHSL.h, baseHSL.s, stepL(i));
      const name = s.name;
      const lineType = name==="NACIONAL" ? 'solid' : (name==="URBANO" ? 'dashed' : (name==="RURAL" ? 'dotted' : 'solid'));
      return {
        name,
        type: 'line',
        smooth: 0.25,
        showSymbol: true,
        symbol: 'circle',
        symbolSize: 6,
        lineStyle: { width: 2, color: col, type: lineType, cap:'round', join:'round' },
        itemStyle: { color: col },
        emphasis: { focus: 'series', scale: false },
        clip: true,
        data: s.data,
        _color: col,
        label: {
          show: true,
          position: 'top',
          distance: 8,
          fontSize: 12,
          color: '#111827',
          formatter: (p)=> (p.value==null||isNaN(p.value)) ? '' : `${nf1.format(+p.value)}%`
        },
        labelLayout: { hideOverlap: true, moveOverlap: 'shiftY' }
      };
    });

    // Eje Y con colchón
    const vals = seriesPrep.flatMap(s=>s.data).filter(v=>v!=null && isFinite(v));
    const vmin = Math.min(...vals), vmax = Math.max(...vals);
    const pad = Math.max((vmax - vmin) * 0.18, 1.2);
    const yMin = Math.max(0, Math.floor((vmin - pad) * 10)/10);
    const yMax = Math.min(105, Math.ceil ((vmax + pad) * 10)/10);

    const legendData = prefer.filter(nm => series.some(s=>s.name===nm));

    chart.clear();
    chart.setOption({
      ...baseOption,
      xAxis: { ...baseOption.xAxis, data: years },
      yAxis: { ...baseOption.yAxis, min: yMin, max: yMax },
      legend: { ...baseOption.legend, data: legendData },
      series,
      graphic: []
    });

    // Click -> drilldown
    chart.off('click');
    chart.on('click', (ev)=>{
      if(ev.componentType==='series' && ev.seriesType==='line'){
        const year = String(ev.name);
        const amb  = up(ev.seriesName); // NACIONAL / URBANO / RURAL
        const color= (chart.getOption().series[ev.seriesIndex]._color) || '#3b82f6';
        loadBars({year, amb, color}).catch(showErr);
      }
    });

    $loading.style.display = 'none';
    $err.style.display = 'none';
    $err.textContent = '';
  }

  // ======= Drilldown (barras por región; excluye NACIONAL) =======
  async function loadBars({year, amb, color}){
    const {anio, ambito, valor, region, ind, dvals} = fields;

    const ambForRegions = (amb === 'NACIONAL') ? 'TOTAL' : amb;

    // Directo y, si no hay, reintento con UPPER()
    let where =
      `${ind}='${INDICADOR_OBJ}' AND ${dvals}='${D_VALORES}' AND ${anio}=${Number(year)} AND ` +
      `UPPER(${region})<>'${REGION_TOTAL}' AND UPPER(${ambito}) LIKE '%${ambForRegions}%'`;

    let res = await jsonp(tableUrl + "/query", {
      where,
      outFields: [region, valor].join(","),
      orderByFields: `${region} ASC`,
      returnGeometry: "false",
      f: "json"
    }, 20000);

    let features = (res.data && res.data.features) || [];
    if(!features.length){
      where =
        `UPPER(${ind})=UPPER('${INDICADOR_OBJ}') AND UPPER(${dvals})=UPPER('${D_VALORES}') AND ${anio}=${Number(year)} AND ` +
        `UPPER(${region})<>'${REGION_TOTAL}' AND UPPER(${ambito}) LIKE '%${ambForRegions}%'`;
      res = await jsonp(tableUrl + "/query", {
        where,
        outFields: [region, valor].join(","),
        orderByFields: `${region} ASC`,
        returnGeometry: "false",
        f: "json"
      }, 20000);
      features = (res.data && res.data.features) || [];
    }
    if(!features.length) throw new Error(`Sin datos para ${ambForRegions} en ${year} (drilldown).`);

    const raw = features.map(f=>f.attributes)
      .filter(r => r && r[region] && r[valor]!=null)
      .map(r => ({ region: norm(r[region]), valor: Number(r[valor]) }));

    // 0..1 -> %
    const maxRaw = Math.max(...raw.map(r=>r.valor));
    const scale = (maxRaw <= 1.5) ? 100 : 1;

    // Agregar por región (promedio)
    const agg = new Map();
    raw.forEach(r=>{
      const key = up(r.region);
      const cur = agg.get(key) || { name: r.region, sum: 0, count: 0 };
      cur.sum += r.valor * scale;
      cur.count += 1;
      agg.set(key, cur);
    });
    const rows = Array.from(agg.values()).map(o => ({
      region: o.name,
      valor : o.sum / o.count
    }));

    rows.sort((a,b)=>b.valor-a.valor);

    const x = rows.map(r=>r.region);
    const y = rows.map(r=>r.valor);

    chart.clear();
    chart.setOption({
      backgroundColor: '#ffffff',
      grid: { left: 96, right: 48, top: 74, bottom: 72, containLabel: true },
      legend: { show:false },
      tooltip: {
        trigger: 'axis',
        axisPointer: { type:'shadow' },
        formatter: (params)=>{
          const p = params && params[0];
          if(!p) return '';
          return `${p.axisValueLabel}<br><b>${nf1.format(+p.value)}%</b>`;
        }
      },
      title: { left: 'center', top: 10, text: `Cloro residual ≥0.5 mg/L — ${ambForRegions} — ${year}` },
      xAxis: { type:'category', data: x, axisLabel:{ interval:0, rotate: (x.length>18?40:(x.length>12?25:0)) } },
      yAxis: { type:'value', name:'%', axisLabel:{ formatter:v=>nf1.format(v) }, scale:true },
      series: [{
        name: 'Región',
        type: 'bar',
        data: y,
        itemStyle: { color: color },
        label: { show:true, position:'top', formatter:(p)=>`${nf1.format(+p.value)}%` }
      }],
      animation: true,
      animationDuration: 900,
      graphic: backGraphic(color, async ()=>{
        try{ await loadLine(); }catch(e){ showErr(e); }
      })
    });

    // ESC para volver
    document.onkeydown = async (e)=>{
      if(e.key === 'Escape'){
        document.onkeydown = null;
        await loadLine().catch(showErr);
      }
    };

    $loading.style.display = 'none';
    $err.style.display = 'none';
    $err.textContent = '';
  }

  // ======= Orquestación =======
  function showErr(e){
    $loading.style.display = 'none';
    $err.style.display = 'block';
    $err.textContent = "Error: " + (e && e.message ? e.message : e);
    console.error(e);
  }

  (async function run(){
    try{
      $loading.style.display = 'flex';
      await initMeta();
      await loadLine();
    }catch(e){ showErr(e); }
  })();

  window.addEventListener('error', (ev)=>{
    showErr(ev && ev.message ? ev.message : ev);
  }, true);
})();
</script>
</body>
</html>
